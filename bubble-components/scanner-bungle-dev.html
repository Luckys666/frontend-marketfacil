<!-- 
  MONOLITHIC DEV BUNDLE - LOCAL TESTING
  Generated by Antigravity on 2025-12-24
  Includes Export CSV Feature
-->
<div class="mf-dashboard-wrapper">
    <div class="ml-analyzer-widget">
        <!-- Controls -->
        <div class="input-area" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
            <div style="flex-grow: 1;">
                <label for="tagFilter" class="text-label" style="display:block; margin-bottom:5px;">Filtrar por
                    Tag:</label>
                <select id="tagFilter" onchange="handleScannerFilterChange()"
                    style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <option value="all">Ver Tudo (Inicie o Scanner)</option>
                </select>
            </div>
            <div style="display: flex; align-items: flex-end; gap: 10px;">
                <button id="scanButton" onclick="startAccountScan()" style="height: 42px;">Escanear Conta</button>
                <button id="exportCsvButton" onclick="exportToCSV()"
                    style="height: 42px; background: #fff !important; color: #3b82f6; border: 1px solid #3b82f6 !important;"
                    title="Exportar resultados atuais para planilha">ðŸ“¥ CSV</button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="scanProgress" style="display: none; margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span id="scanStatusText" class="text-small" style="font-weight: 600;">Iniciando...</span>
                <span id="scanCountText" class="text-small">0 encontrados</span>
            </div>
            <div class="char-counter-bar">
                <div id="scanProgressBar" class="char-progress" style="width: 0%; background: #3b82f6;"></div>
            </div>
        </div>

        <!-- Results Area -->
        <div id="scannerResults"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">
            <div class="ana-card initial-placeholder"
                style="grid-column: 1 / -1; text-align: center; color: #94a3b8; padding: 40px;">
                Selecione um filtro e clique em "Escanear Conta" para comeÃ§ar.
            </div>
        </div>
    </div>
</div>
<style>
    /* CORE CSS */
    /* Scoped Variables - applied to wrapper */
    .mf-dashboard-wrapper {
        --bg-color: #f4f6f8;
        --card-bg: #ffffff;
        --primary-color: #3b82f6;
        /* Modern Blue */
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --radius: 8px;
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);

        /* Font applied only to wrapper */
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: var(--text-primary);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
    }

    .mf-dashboard-wrapper * {
        box-sizing: border-box;
    }

    /* Replaced body/global styles with wrapper-scoped styles */
    .mf-dashboard-wrapper .dashboard-header {
        margin-bottom: var(--spacing-lg);
    }

    .mf-dashboard-wrapper .dashboard-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .mf-dashboard-wrapper .dashboard-header p {
        color: var(--text-secondary);
    }

    .mf-dashboard-wrapper .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-lg);
    }

    .mf-dashboard-wrapper .card {
        background: var(--card-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: var(--spacing-lg);
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease;
    }

    .mf-dashboard-wrapper .card:hover {
        transform: translateY(-2px);
    }

    .mf-dashboard-wrapper .card h2 {
        font-size: 1.25rem;
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
    }

    .mf-dashboard-wrapper .card p {
        color: var(--text-secondary);
    }

    .mf-dashboard-wrapper .status-indicator {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        background-color: #ecfdf5;
        color: #059669;
        font-size: 0.875rem;
        border-radius: 100px;
        margin-top: var(--spacing-md);
    }

    .mf-dashboard-wrapper .btn {
        display: inline-block;
        background-color: var(--primary-color);
        color: white;
        padding: 8px 16px;
        border-radius: var(--radius);
        text-decoration: none;
        font-weight: 500;
        margin-top: var(--spacing-md);
        cursor: pointer;
        border: none;
    }

    .mf-dashboard-wrapper .btn:hover {
        opacity: 0.9;
    }

    /* VISITS CSS */
    /* --- PREMIUM VISITS WIDGET STYLES (Namespaced) --- */
    .mf-widget .visits-widget-container {
        font-family: 'Inter', sans-serif;
        min-height: 450px;
        background: #ffffff;
        border-radius: 24px;
        box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
        padding: 30px;
        position: relative;
        overflow: hidden;
    }

    .mf-widget .widget-header {
        position: relative;
        z-index: 10;
        margin-bottom: 30px;
    }

    .mf-widget .widget-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        letter-spacing: -0.02em;
        margin-bottom: 0;
        /* Override potential defaults */
    }

    .mf-widget .widget-subtitle {
        color: #6B7280;
        font-size: 0.875rem;
        margin-top: 4px;
    }

    .mf-widget .controls-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 24px;
    }

    @media (min-width: 768px) {
        .mf-widget .controls-grid {
            grid-template-columns: 2fr 1fr 120px;
        }
    }

    .mf-widget .input-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #9CA3AF;
        margin-bottom: 6px;
        letter-spacing: 0.05em;
    }

    .mf-widget .status-input {
        width: 100%;
        height: 48px;
        padding: 0 16px;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        background: #F9FAFB;
        font-size: 0.95rem;
        color: #1F2937;
        transition: all 0.2s ease;
        outline: none;
    }

    .mf-widget .status-input:focus {
        background: #fff;
        border-color: #3B82F6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .mf-widget .btn-search {
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
        color: white;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.2s;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    .mf-widget .btn-search:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
    }

    .mf-widget .btn-search:active {
        transform: translateY(1px);
    }

    .mf-widget .btn-search:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    .mf-widget .chart-wrapper {
        background: #fff;
        border: 1px solid #F3F4F6;
        border-radius: 16px;
        padding: 20px;
        height: 320px;
        position: relative;
    }

    .mf-widget .feedback-msg {
        padding: 12px;
        border-radius: 10px;
        font-size: 0.875rem;
        text-align: center;
        margin-bottom: 20px;
        display: none;
        animation: mf-fadeIn 0.3s ease;
    }

    .mf-widget .feedback-success {
        background: #ECFDF5;
        color: #065F46;
        border: 1px solid #D1FAE5;
    }

    .mf-widget .feedback-error {
        background: #FEF2F2;
        color: #991B1B;
        border: 1px solid #FEE2E2;
    }

    .mf-widget .loading-state {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6B7280;
    }

    .mf-widget .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #E5E7EB;
        border-top-color: #3B82F6;
        border-radius: 50%;
        animation: mf-spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes mf-spin {
        to {
            transform: rotate(360deg);
        }
    }

    @keyframes mf-fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ANALYZER CSS */
    /* --- AD ANALYZER WIDGET PREMIUM STYLES (Super Stylish & Animated) --- */

    /* Keyframes & Animations */
    @keyframes slideUpFade {
        0% {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }

        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes pulseGlow {
        0% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }

        70% {
            box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
    }

    @keyframes gradientBorder {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }

    @keyframes expandWidth {
        from {
            width: 0;
        }

        to {
            width: var(--w);
        }
    }

    @keyframes rainbowGlow {

        0%,
        100% {
            filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5));
        }

        50% {
            filter: drop-shadow(0 0 15px rgba(168, 85, 247, 0.6));
        }
    }

    /* Scoped Variables for Analyzer */
    .ml-analyzer-widget {
        --ana-bg-color: #ffffff;
        --ana-bg-glass: rgba(255, 255, 255, 0.95);
        --ana-text-main: #0f172a;
        /* Slate 900 */
        --ana-text-muted: #64748b;
        /* Slate 500 */

        /* Vibrant Palette */
        --ana-primary: #3b82f6;
        /* Blue 500 */
        --ana-primary-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);

        --ana-success: #10b981;
        /* Emerald 500 */
        --ana-success-soft: #d1fae5;
        --ana-success-gradient: linear-gradient(135deg, #34d399 0%, #059669 100%);

        --ana-warning: #f59e0b;
        /* Amber 500 */
        --ana-warning-soft: #fef3c7;

        --ana-danger: #ef4444;
        /* Red 500 */
        --ana-danger-soft: #fee2e2;
        --ana-danger-gradient: linear-gradient(135deg, #f87171 0%, #dc2626 100%);

        --ana-border: #e2e8f0;
        --ana-bg-page: #f1f5f9;
        /* Slate 100 */
        --ana-radius: 16px;
        --ana-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.08);
        --ana-shadow-hover: 0 20px 40px -5px rgba(0, 0, 0, 0.12);

        font-family: 'Inter', system-ui, sans-serif;
        color: var(--ana-text-main);
        background-color: var(--ana-bg-page);
        padding: 30px;
        border-radius: 20px;
        /* Updated from var(--ana-radius) */
        box-sizing: border-box;
        width: 100%;
        line-height: 1.6;
        position: relative;
        overflow: visible;
    }

    /* Layout Grid */
    .ml-analyzer-widget .analysis-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 24px;
        margin-top: 30px;
    }

    .ml-analyzer-widget .grid-full {
        grid-column: span 12;
    }

    .ml-analyzer-widget .grid-half {
        grid-column: span 6;
    }

    .ml-analyzer-widget .grid-third {
        grid-column: span 4;
    }

    @media (max-width: 900px) {

        .ml-analyzer-widget .grid-half,
        .ml-analyzer-widget .grid-third {
            grid-column: span 12;
        }
    }

    /* Premium Cards */
    .ml-analyzer-widget .ana-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
        /* backdrop-filter removed as we use solid white for cleaner look */
    }

    .ml-analyzer-widget .ana-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--ana-shadow-hover);
        border-color: rgba(59, 130, 246, 0.3);
    }

    .ml-analyzer-widget .ana-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--ana-border);
    }

    .ml-analyzer-widget .ana-card-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--ana-text-main);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        background: linear-gradient(90deg, #1e293b, #3b82f6);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .ml-analyzer-widget .ana-card-icon {
        font-size: 1.4rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    /* Input Area - Container Box */
    .ml-analyzer-widget .input-area {
        background: #ffffff;
        padding: 25px 50px;
        /* User specified: 25px vertical, 50px horizontal */
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        display: flex;
        align-items: flex-end;
        gap: 20px;
        border: 1px solid #e2e8f0;
        width: 100%;
        box-sizing: border-box;
        margin: 0 0 20px 0;
        /* User specified: 20px bottom margin */
        transition: all 0.3s ease;
        flex-wrap: wrap;
        /* Allows wrapping on small screens */
    }

    .ml-analyzer-widget .input-area:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border-color: #cbd5e1;
    }

    .ml-analyzer-widget .input-area:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .ml-analyzer-widget #input-url {
        border: none;
        background: transparent;
        flex-grow: 1;
        padding: 12px 24px;
        font-size: 1.1rem;
        color: var(--ana-text-main);
        outline: none;
    }

    .ml-analyzer-widget button {
        background: var(--ana-primary-gradient);
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    .ml-analyzer-widget button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }

    /* --- TITLE ANALYSIS UX --- */
    .ml-analyzer-widget .title-display {
        font-size: 1.35rem;
        font-weight: 700;
        line-height: 1.3;
        margin-bottom: 12px;
    }

    .ml-analyzer-widget .char-counter-bar {
        height: 8px;
        width: 100%;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
        position: relative;
    }

    .ml-analyzer-widget .char-progress {
        height: 100%;
        background: var(--ana-primary-gradient);
        border-radius: 4px;
        width: 0;
        /* Animated via JS or inline style */
        transition: width 1s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s;
    }

    .ml-analyzer-widget .char-progress.good {
        background: var(--ana-success-gradient);
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .ml-analyzer-widget .char-progress.bad {
        background: var(--ana-danger-gradient);
    }

    .ml-analyzer-widget .char-progress.neutral {
        background: var(--ana-warning);
    }

    /* --- TECH SPECS UX --- */
    .ml-analyzer-widget .specs-group {
        margin-bottom: 20px;
    }

    .ml-analyzer-widget .specs-group-title {
        font-size: 0.85rem;
        text-transform: uppercase;
        font-weight: 700;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ml-analyzer-widget .specs-group-title.problem {
        color: var(--ana-danger);
    }

    .ml-analyzer-widget .specs-group-title.valid {
        color: var(--ana-success);
    }

    .ml-analyzer-widget .attribute-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #f8fafc;
        border: 1px solid transparent;
        transition: all 0.2s;
    }

    .ml-analyzer-widget .attribute-item.problem {
        background: #fef2f2;
        border-color: #fecaca;
        animation: slideUpFade 0.5s forwards;
    }

    .ml-analyzer-widget .attribute-item:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* --- QUALITY SCORE (The Big Circle) --- */
    .ml-analyzer-widget .score-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        position: relative;
    }

    .ml-analyzer-widget .score-circle-outer {
        position: relative;
        width: 140px;
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ml-analyzer-widget .circular-chart {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        max-height: 100%;
    }

    .ml-analyzer-widget .circle-bg {
        fill: none;
        stroke: #e2e8f0;
        stroke-width: 2.5;
        /* Thinner for elegance */
    }

    .ml-analyzer-widget .circle {
        fill: none;
        stroke-width: 3.5;
        stroke-linecap: round;
        transition: stroke-dasharray 1.5s ease-out;
        filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.2));
    }

    .ml-analyzer-widget .circle.good {
        stroke: url(#gradientGood);
        animation: pulseGlow 2s infinite;
    }

    .ml-analyzer-widget .circle.neutral {
        stroke: #f59e0b;
    }

    .ml-analyzer-widget .circle.bad {
        stroke: #ef4444;
    }

    .ml-analyzer-widget .score-number {
        position: absolute;
        font-size: 2.8rem;
        font-weight: 800;
        color: var(--ana-text-main);
    }

    .ml-analyzer-widget .celebration-confetti {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0) 100%);
        /* Can add background image confetti gif if needed, or simple CSS particles */
    }

    /* Status Messages */
    .ml-analyzer-widget .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .ml-analyzer-widget .status-badge.success {
        background: var(--ana-success-soft);
        color: #065f46;
    }

    .ml-analyzer-widget .status-badge.error {
        background: var(--ana-danger-soft);
        color: #991b1b;
    }

    .ml-analyzer-widget .status-badge.muted {
        background: #f1f5f9;
        color: #64748b;
    }

    /* Visits Trend & Reviews */
    .ml-analyzer-widget .trend-indicator {
        background: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
        padding: 15px;
        border-radius: 12px;
    }

    /* Loading Overlay */
    .ml-analyzer-widget #loadingIndicator {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: var(--ana-radius);
        animation: fade 0.3s;
    }

    .ml-analyzer-widget .loader-pill {
        background: white;
        padding: 16px 32px;
        border-radius: 60px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        font-weight: 700;
        color: var(--ana-primary);
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid rgba(255, 255, 255, 0.8);
    }

    /* Typography Helpers */
    .ml-analyzer-widget .text-label {
        font-size: 0.85rem;
        color: var(--ana-text-muted);
        font-weight: 600;
        text-transform: uppercase;
    }

    .ml-analyzer-widget .text-value {
        font-size: 1rem;
        color: var(--ana-text-main);
        font-weight: 500;
    }

    .ml-analyzer-widget .text-small {
        font-size: 0.85rem;
        color: var(--ana-text-muted);
    }

    /* Error Message */
    .ml-analyzer-widget .error-message {
        background: #fef2f2;
        color: #991b1b;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid #fecaca;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
    }

    .ml-analyzer-widget ul {
        list-style: none;
    }

    /* Estilo comum para tÃ­tulos de seÃ§Ã£o com sublinhado */
    .ml-analyzer-widget .section-title-underlined {
        margin-bottom: 10px;
        border-bottom: 2px solid #007bff;
        /* Sublinhado azul padrÃ£o */
        padding-bottom: 5px;
        display: inline-block;
        font-size: 1.1em;
        font-weight: 600;
    }

    /* Cor especÃ­fica para o tÃ­tulo de Detalhes da Qualidade */
    .ml-analyzer-widget #performanceTexto .section-title-underlined {
        border-bottom-color: #28a745;
        /* Verde para detalhes da qualidade */
    }


    /* Ãrea de Input */
    .ml-analyzer-widget .input-area {
        margin-bottom: 20px;
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Caixa de ObservaÃ§Ã£o */
    .ml-analyzer-widget .info-box {
        background-color: #e9ecef;
        border-left: 4px solid #007bff;
        padding: 10px 15px;
        margin-bottom: 20px;
        font-size: 0.9em;
        color: #495057;
        border-radius: 4px;
    }

    .ml-analyzer-widget .info-box p {
        margin: 5px 0;
    }

    .ml-analyzer-widget .info-box details summary {
        cursor: pointer;
        color: #007bff;
        font-weight: 500;
    }

    .ml-analyzer-widget .info-box details p {
        margin-top: 8px;
        word-break: break-all;
        padding-left: 10px;
        border-left: 2px solid #ced4da;
    }


    .ml-analyzer-widget #input-url {
        flex-grow: 1;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
        min-width: 180px;
    }

    .ml-analyzer-widget #input-url:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .ml-analyzer-widget button {
        padding: 10px 18px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s ease-in-out;
        flex-shrink: 0;
    }

    .ml-analyzer-widget button:hover {
        background-color: #0056b3;
    }

    /* Container de Resultados */
    .ml-analyzer-widget #resultsContainer {
        margin-top: 15px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        background-color: #fff;
        min-height: 80px;
        /* Altura mÃ­nima para manter o container visÃ­vel mesmo vazio */
        position: relative;
        box-sizing: border-box;
    }

    .ml-analyzer-widget #resultsContainer .initial-text {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 20px;
    }


    /* Indicador de Carregamento */
    .ml-analyzer-widget #loadingIndicator {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #6c757d;
        font-size: 1em;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(248, 249, 250, 0.85);
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 8px;
        box-sizing: border-box;
    }

    .ml-analyzer-widget #loadingIndicator span {
        background-color: #fff;
        padding: 12px 25px;
        border-radius: 20px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
        font-weight: bold;
        color: #007bff;
    }

    /* Imagem do Produto */
    .ml-analyzer-widget #productImage {
        max-width: 120px;
        max-height: 120px;
        float: right;
        margin: 0 0 12px 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #f8f9fa;
        padding: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        object-fit: contain;
        display: none;
        /* ComeÃ§a escondida e sÃ³ Ã© mostrada via JS */
    }


    /* SeÃ§Ãµes de InformaÃ§Ã£o */
    /* SeÃ§Ãµes de InformaÃ§Ã£o */
    .ml-analyzer-widget #tituloTexto,
    .ml-analyzer-widget #descricaoIndicator,
    .ml-analyzer-widget #fichaTecnicaTexto,
    .ml-analyzer-widget #categoryAttributes,
    .ml-analyzer-widget #warrantyInfo,
    .ml-analyzer-widget #tagsTexto,
    .ml-analyzer-widget #upTagsTexto,
    .ml-analyzer-widget #mlbuItemsList,
    .ml-analyzer-widget #performanceTexto {
        margin-bottom: 15px;
    }

    /* SeÃ§Ã£o de TÃ­tulo */
    .ml-analyzer-widget #tituloTexto p {
        font-size: 1.2em;
        font-weight: 600;
        margin-top: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }

    .ml-analyzer-widget #tituloTexto small {
        font-size: 0.75em;
        color: #555;
        font-weight: normal;
        display: block;
        margin-top: 4px;
    }

    .ml-analyzer-widget #tituloTexto p[style*="color: gray"] {
        color: #6c757d !important;
    }

    /* Indicadores de DescriÃ§Ã£o e Garantia - Estilo dos parÃ¡grafos de status */
    .ml-analyzer-widget #descricaoIndicator .status-message,
    .ml-analyzer-widget #warrantyInfo .status-message {
        margin-top: 8px;
        margin-bottom: 6px;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid transparent;
        font-size: 0.9em;
    }

    .ml-analyzer-widget .status-message[style*="color: red"] {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24 !important;
    }

    .ml-analyzer-widget .status-message[style*="color: green"] {
        background-color: #d1e7dd;
        border-color: #badbcc;
        color: #0f5132 !important;
    }

    .ml-analyzer-widget .status-message[style*="color: gray"] {
        background-color: #e9ecef;
        border-color: #dee2e6;
        color: #495057 !important;
    }


    /* Ficha TÃ©cnica e Atributos da Categoria */
    .ml-analyzer-widget #fichaTecnicaTexto,
    .ml-analyzer-widget #categoryAttributes {
        margin-top: 15px;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p,
    .ml-analyzer-widget #categoryAttributes li {
        margin-bottom: 8px;
        padding: 4px 0 4px 8px;
        border-left: 3px solid #eee;
        position: relative;
        font-size: 0.95em;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p:has(> strong[style*="color: green"]),
    .ml-analyzer-widget #categoryAttributes li.filled {
        border-left-color: #198754;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p:has(> strong[style*="color: gray"]) {
        border-left-color: #adb5bd;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p:has(> strong[style*="color: red"]),
    .ml-analyzer-widget #categoryAttributes li.not-filled {
        border-left-color: #dc3545;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p:has(> strong[style*="color: inherit"]) {
        border-left-color: #eee;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p>strong[style*="color: green"] {
        color: #198754 !important;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p>strong[style*="color: gray"] {
        color: #6c757d !important;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p>strong[style*="color: red"] {
        color: #dc3545 !important;
    }

    .ml-analyzer-widget #fichaTecnicaTexto p>strong[style*="color: inherit"] {
        color: #333 !important;
    }

    /* Estilos para a lista de itens MLBU */
    .ml-analyzer-widget #mlbuItemsList ul {
        list-style-type: none;
        padding-left: 0;
    }

    .ml-analyzer-widget #mlbuItemsList li {
        margin-bottom: 5px;
    }

    .ml-analyzer-widget #mlbuItemsList button {
        width: 100%;
        text-align: left;
        background-color: #e9ecef;
        color: #007bff;
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        font-size: 0.95em;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s, border-color 0.2s;
        display: flex;
        /* Adicionado para alinhar imagem e texto */
        align-items: center;
        /* Adicionado para alinhar imagem e texto */
        gap: 10px;
        /* EspaÃ§o entre imagem e texto */
    }

    .ml-analyzer-widget #mlbuItemsList button:hover {
        background-color: #d1e7ff;
        border-color: #b8daff;
    }

    .ml-analyzer-widget #mlbuItemsList button img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        border-radius: 4px;
        background-color: #fff;
    }

    .ml-analyzer-widget #mlbuItemsList button .item-details {
        flex-grow: 1;
    }

    .ml-analyzer-widget #mlbuItemsList button .item-listing-type {
        font-style: italic;
        color: #6c757d;
        font-size: 0.9em;
    }


    /* Avisos (Comprimento e RepetiÃ§Ã£o) */
    .ml-analyzer-widget .length-warning,
    .ml-analyzer-widget .repeticao-info {
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 0.75em;
        font-style: italic;
        margin-left: 6px;
        cursor: help;
        white-space: nowrap;
        display: inline-block;
    }

    .ml-analyzer-widget .length-warning:before {
        content: "âš ï¸ ";
        font-style: normal;
    }

    .ml-analyzer-widget .repeticao-info {
        background-color: rgba(220, 53, 69, 0.08);
        color: #dc3545;
        border: 1px dashed rgba(220, 53, 69, 0.3);
    }

    /* SeÃ§Ã£o Detalhes da Qualidade do AnÃºncio (anteriormente Performance) */
    .ml-analyzer-widget #performanceTexto {
        margin-top: 20px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }

    .ml-analyzer-widget #performanceTexto>p.overall-performance-score {
        font-size: 1.05em;
        margin-bottom: 15px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .ml-analyzer-widget #performanceTexto>p.overall-performance-score>.score-details {
        flex-grow: 1;
    }

    .ml-analyzer-widget #performanceTexto>p.overall-performance-score>.circular-progress.medium {
        margin-left: auto;
    }

    .ml-analyzer-widget .performance-mode {
        font-size: 0.9em;
        font-weight: normal;
        margin-left: 5px;
    }

    .ml-analyzer-widget .performance-mode.opportunity {
        color: #28a745;
    }

    .ml-analyzer-widget .performance-mode.warning {
        color: #ffc107;
    }

    .ml-analyzer-widget .performance-mode.critical-warning {
        color: #dc3545;
    }

    .ml-analyzer-widget .performance-bucket {
        margin-top: 10px;
        padding-left: 12px;
        border-left: 3px solid #ccc;
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 8px;
        font-size: 0.95em;
    }

    .ml-analyzer-widget .performance-bucket[data-score-level="good"] {
        border-left-color: #198754;
    }

    .ml-analyzer-widget .performance-bucket[data-score-level="neutral"] {
        border-left-color: #ffc107;
    }

    .ml-analyzer-widget .performance-bucket[data-score-level="bad"] {
        border-left-color: #dc3545;
    }

    .ml-analyzer-widget .performance-bucket h5 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1em;
        font-weight: bold;
        color: #333;
        border-bottom: 1px dashed #eee;
        padding-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ml-analyzer-widget .performance-variable {
        margin-bottom: 6px;
        padding-left: 8px;
        border-left: 2px solid transparent;
        font-size: 0.9em;
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .ml-analyzer-widget .performance-variable[data-status="COMPLETED"] {
        border-left-color: #28a745;
    }

    .ml-analyzer-widget .performance-variable[data-status="PENDING"] {
        border-left-color: #ffc107;
    }

    .ml-analyzer-widget .performance-variable[data-status="ERROR"] {
        border-left-color: #dc3545;
    }

    .ml-analyzer-widget .performance-variable[data-status="UNKNOWN"] {
        border-left-color: #ccc;
    }

    .ml-analyzer-widget .performance-variable strong {
        font-weight: 600;
        margin-right: 5px;
    }

    .ml-analyzer-widget .performance-variable span.score,
    .ml-analyzer-widget .performance-variable span.status {
        display: none;
    }

    .ml-analyzer-widget .performance-variable .suggestion {
        display: none;
        font-size: 0.85em;
        color: #555;
        margin-top: 4px;
        font-style: normal;
        flex-basis: 100%;
        padding-left: calc(30px + 8px);
    }

    .ml-analyzer-widget .performance-variable .suggestion::before {
        content: "ðŸ’¡ SugestÃ£o: ";
        font-weight: bold;
        color: #007bff;
    }

    .ml-analyzer-widget .performance-variable.active .suggestion {
        display: block;
    }

    .ml-analyzer-widget .variable-dropdown-arrow {
        margin-left: auto;
        font-size: 0.8em;
        color: #555;
        transition: transform 0.3s ease;
    }

    .ml-analyzer-widget .performance-variable.active .variable-dropdown-arrow {
        transform: rotate(180deg);
    }

    /* PontuaÃ§Ã£o de Qualidade e Indicadores Circulares */
    .ml-analyzer-widget #qualityScore {
        padding-top: 15px;
        border-top: 2px solid #e9ecef;
        margin-top: 20px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .ml-analyzer-widget #qualityScore p {
        font-size: 1.2em;
        font-weight: bold;
        margin: 0 0 10px 0;
    }

    .ml-analyzer-widget .circular-progress {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: conic-gradient(var(--progress-color, #e0e0e0) 0% var(--score-percent, 0%), #e0e0e0 var(--score-percent, 0%) 100%);
        --score: 0;
        --score-percent: calc(var(--score) * 1%);
        --progress-color: #e0e0e0;
        transition: background 1s ease-in-out, --progress-color 1s ease-in-out;
    }

    .ml-analyzer-widget .circular-progress::before {
        content: "";
        position: absolute;
        width: 80%;
        height: 80%;
        border-radius: 50%;
        background-color: #fff;
    }

    .ml-analyzer-widget .circular-progress .score-text {
        position: relative;
        font-size: 1.5em;
        font-weight: bold;
        color: #333;
        z-index: 1;
    }

    .ml-analyzer-widget .circular-progress[data-score-level="good"] {
        --progress-color: #4CAF50;
    }

    .ml-analyzer-widget .circular-progress[data-score-level="good"] .score-text {
        color: #4CAF50;
    }

    .ml-analyzer-widget .circular-progress[data-score-level="neutral"] {
        --progress-color: #FFC107;
    }

    .ml-analyzer-widget .circular-progress[data-score-level="neutral"] .score-text {
        color: #FF8F00;
    }

    .ml-analyzer-widget .circular-progress[data-score-level="bad"] {
        --progress-color: #F44336;
    }

    .ml-analyzer-widget .circular-progress[data-score-level="bad"] .score-text {
        color: #F44336;
    }

    .ml-analyzer-widget .circular-progress[data-score-level="unknown"] {
        --progress-color: #9e9e9e;
    }

    .ml-analyzer-widget .circular-progress[data-score-level="unknown"] .score-text {
        color: #757575;
    }

    .ml-analyzer-widget .circular-progress.medium {
        width: 70px;
        height: 70px;
    }

    .ml-analyzer-widget .circular-progress.medium .score-text {
        font-size: 1.2em;
    }

    .ml-analyzer-widget .circular-progress.medium::before {
        width: 75%;
        height: 75%;
    }

    .ml-analyzer-widget .circular-progress.small {
        width: 50px;
        height: 50px;
        font-size: 1em;
        flex-shrink: 0;
    }

    .ml-analyzer-widget .circular-progress.small::before {
        width: 70%;
        height: 70%;
    }

    .ml-analyzer-widget .circular-progress.small .score-text {
        font-size: 0.8em;
    }

    .ml-analyzer-widget .circular-progress.tiny {
        width: 30px;
        height: 30px;
        font-size: 0.8em;
        flex-shrink: 0;
    }

    .ml-analyzer-widget .circular-progress.tiny::before {
        content: "";
        position: absolute;
        width: 60%;
        height: 60%;
        border-radius: 50%;
        background-color: #fff;
    }

    .ml-analyzer-widget .circular-progress.tiny .score-text {
        font-size: 0.6em;
    }

    /* Mensagens de Erro */
    .ml-analyzer-widget .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #842029 !important;
        padding: 12px;
        margin: 12px 0;
        border-radius: 4px;
        font-weight: normal !important;
        clear: both;
        font-size: 0.95em;
    }

    .ml-analyzer-widget .error-message::before {
        content: "âš ï¸ ";
        font-weight: bold;
        font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
    }

    /* Container para anÃ¡lise de item especÃ­fico */
    .ml-analyzer-widget .item-analysis-container {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #007bff;
        border-radius: 5px;
        background-color: #f0f8ff;
    }


    /* Design Responsivo */
    @media (max-width: 768px) {
        .ml-analyzer-widget {
            padding: 20px;
            margin: 15px auto;
        }

        .ml-analyzer-widget .performance-bucket {
            padding-left: 10px;
        }

        .ml-analyzer-widget .performance-variable {
            padding-left: 6px;
        }

        .ml-analyzer-widget .circular-progress {
            width: 80px;
            height: 80px;
        }

        .ml-analyzer-widget .circular-progress .score-text {
            font-size: 1.2em;
        }

        .ml-analyzer-widget .circular-progress.medium {
            width: 60px;
            height: 60px;
        }

        .ml-analyzer-widget .circular-progress.medium .score-text {
            font-size: 1em;
        }

        .ml-analyzer-widget .performance-bucket .circular-progress.small {
            width: 40px;
            height: 40px;
        }

        .ml-analyzer-widget .performance-bucket .circular-progress.small .score-text {
            font-size: 0.7em;
        }

        .ml-analyzer-widget .circular-progress.tiny {
            width: 25px;
            height: 25px;
        }

        .ml-analyzer-widget .circular-progress.tiny .score-text {
            font-size: 0.5em;
        }
    }

    @media (max-width: 600px) {
        .ml-analyzer-widget {
            padding: 15px;
            margin: 10px auto;
        }

        .ml-analyzer-widget .input-area {
            flex-direction: column;
            align-items: stretch;
        }

        .ml-analyzer-widget #input-url {
            margin-right: 0;
            margin-bottom: 8px;
        }

        .ml-analyzer-widget #tituloTexto,
        .ml-analyzer-widget #descricaoIndicator,
        .ml-analyzer-widget #fichaTecnicaTexto,
        .ml-analyzer-widget #warrantyInfo,
        .ml-analyzer-widget #tagsTexto,
        .ml-analyzer-widget #performanceTexto,
        .ml-analyzer-widget #qualityScore {
            clear: both;
        }

        .ml-analyzer-widget #tituloTexto p,
        .ml-analyzer-widget #qualityScore p {
            font-size: 1.1em;
        }

        .ml-analyzer-widget .length-warning,
        .ml-analyzer-widget .repeticao-info {
            display: block;
            margin-left: 0;
            margin-top: 4px;
            white-space: normal;
            width: fit-content;
        }

        .ml-analyzer-widget .performance-bucket {
            padding: 6px 10px;
        }

        .ml-analyzer-widget .performance-bucket h5 {
            margin-bottom: 6px;
        }

        .ml-analyzer-widget .performance-variable {
            margin-bottom: 4px;
            padding-left: 4px;
            font-size: 0.85em;
        }

        .ml-analyzer-widget .circular-progress {
            width: 70px;
            height: 70px;
        }

        .ml-analyzer-widget .circular-progress .score-text {
            font-size: 1em;
        }

        .ml-analyzer-widget .circular-progress.medium {
            width: 50px;
            height: 50px;
        }

        .ml-analyzer-widget .circular-progress.medium .score-text {
            font-size: 0.9em;
        }

        .ml-analyzer-widget .performance-bucket .circular-progress.small {
            width: 35px;
            height: 35px;
        }

        .ml-analyzer-widget .performance-bucket .circular-progress.small .score-text {
            font-size: 0.6em;
        }

        .ml-analyzer-widget .circular-progress.tiny {
            width: 20px;
            height: 20px;
        }

        .ml-analyzer-widget .circular-progress.tiny .score-text {
            font-size: 0.4em;
        }
    }

    /* --- Visits Trend Styles --- */
    .ml-analyzer-widget .visits-trend-card {
        background: #ffffff !important;
        border: 1px solid #e5e7eb !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .ml-analyzer-widget .visits-trend-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    /* --- Reviews Styles --- */
    .ml-analyzer-widget .reviews-summary {
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .ml-analyzer-widget .reviews-list {
        margin-top: 10px;
    }

    .ml-analyzer-widget .review-item {
        transition: background-color 0.2s;
        border-left: 3px solid transparent !important;
    }

    .ml-analyzer-widget .review-item:hover {
        background-color: #f8f9fa !important;
        border-left-color: #3b82f6 !important;
    }

    /* Scrollbar estilizada para review list */
    .ml-analyzer-widget .reviews-list::-webkit-scrollbar {
        width: 6px;
    }

    .ml-analyzer-widget .reviews-list::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .ml-analyzer-widget .reviews-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .ml-analyzer-widget .reviews-list::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* --- Scanner Specific Controls --- */
    .ml-analyzer-widget #tagFilter {
        background-color: #ffffff;
        border: 1px solid #cbd5e1 !important;
        border-radius: 12px !important;
        padding: 12px 16px !important;
        font-size: 0.95rem;
        color: #334155;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
        padding-right: 40px !important;
    }

    .ml-analyzer-widget #tagFilter:hover {
        border-color: #94a3b8 !important;
    }

    .ml-analyzer-widget #tagFilter:focus {
        outline: none;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .ml-analyzer-widget #scanButton {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
        color: white;
        border: none;
        border-radius: 12px !important;
        padding: 0 32px !important;
        font-weight: 600;
        font-size: 1rem;
        height: 48px !important;
        /* Slightly taller for grandeur */
        cursor: pointer;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1), 0 2px 4px -1px rgba(37, 99, 235, 0.06);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .ml-analyzer-widget #scanButton:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.2), 0 4px 6px -2px rgba(37, 99, 235, 0.1);
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
    }

    .ml-analyzer-widget #scanButton:active {
        transform: translateY(0);
    }

    .ml-analyzer-widget #scanButton:disabled {
        background: #e2e8f0 !important;
        color: #94a3b8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .ml-analyzer-widget #exportCsvButton {
        background: #ffffff !important;
        color: #3b82f6;
        border: 1px solid #3b82f6 !important;
        border-radius: 12px !important;
        padding: 0 20px !important;
        font-weight: 600;
        font-size: 0.9rem;
        height: 48px !important;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .ml-analyzer-widget #exportCsvButton:hover {
        background: #eff6ff !important;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
    }
</style>
<script>
    /* ANALYZER JS */
    /**
     * Ad Analyzer Widget Logic
     */

    // -------------- Constantes de ConfiguraÃ§Ã£o --------------
    const MIN_CHARS_TITULO_RUIM = 40;
    const MIN_CHARS_TITULO_BOM = 50;
    const MAX_CHARS_TITULO_BOM = 60;
    const PONTOS_PENALIDADE_TITULO_CURTO = -15;
    const PONTOS_PENALIDADE_TITULO_MEDIO = -8;
    const TAMANHO_IDEAL_ATRIBUTO = 30;
    const PONTOS_PENALIDADE_POR_10_CHARS_DIF_ATR = -2;
    const PONTOS_PENALIDADE_POR_PALAVRA_REPETIDA = -3;
    const PONTOS_PENALIDADE_SEM_ATRIBUTOS = -15;
    const PONTOS_PENALIDADE_MODERATION_PENALTY = -50;
    const PONTOS_BONUS_DESCRICAO = 5;
    const ATRIBUTOS_IGNORADOS_REPETICAO = new Set([]); // Lista limpa para ser mais rigoroso
    const ATRIBUTOS_IGNORADOS_COMPLETAMENTE = new Set(['GTIN', 'SKU', 'SELLER_SKU', 'INMETRO_CERTIFICATION_REGISTRATION_NUMBER']);
    const VALORES_IGNORADOS_PENALIDADE = new Set(['isento', 'nÃ£o aplicÃ¡vel', 'na']);

    const tagSignificados = {
        "good_quality_picture": "AnÃºncio possui fotos de boa qualidade.",
        "good_quality_thumbnail": "A foto principal (miniatura) do anÃºncio Ã© de boa qualidade.",
        "poor_quality_picture": "AnÃºncio possui fotos de baixa qualidade.",
        "poor_quality_thumbnail": "A foto principal (miniatura) do anÃºncio Ã© de baixa qualidade.",
        "brand_verified": "A marca do produto foi verificada pelo Mercado Livre.",
        "extended_warranty_eligible": "O produto Ã© elegÃ­vel para garantia estendida.",
        "immediate_payment": "Pagamento deve ser feito imediatamente.",
        "cart_eligible": "O produto pode ser adicionado ao carrinho de compras.",
        "incomplete_technical_specs": "A ficha tÃ©cnica do produto estÃ¡ incompleta (segundo tag do ML).",
        "catalog_product_candidate": "Este anÃºncio Ã© um candidato a usar o catÃ¡logo do Mercado Livre.",
        "moderation_penalty": "Penalidade por moderaÃ§Ã£o. ViolaÃ§Ã£o de regra detectada.",
        "free_shipping": "O anÃºncio oferece frete grÃ¡tis.",
    };
    const TAGS_NEGATIVAS = new Set([
        "poor_quality_picture", "poor_quality_thumbnail",
        "incomplete_technical_specs", "moderation_penalty"
    ]);

    const BASE_URL_PROXY = 'https://mlb-proxy-fdb71524fd60.herokuapp.com';
    const API_FETCH_ITEM_ENDPOINT = `${BASE_URL_PROXY}/api/fetch-item`; // Rota unificada para item(s) e descriÃ§Ã£o
    const API_USER_PRODUCTS_ENDPOINT = `${BASE_URL_PROXY}/api/user-products`; // ROTA PARA MLBU
    const API_ATTRIBUTES_ENDPOINT = `${BASE_URL_PROXY}/api/attributes`;
    const API_PERFORMANCE_ENDPOINT = `${BASE_URL_PROXY}/api/performance`;
    const API_VISITS_ENDPOINT = `${BASE_URL_PROXY}/api/visits`; // Nova rota para visitas
    const API_REVIEWS_ENDPOINT = `${BASE_URL_PROXY}/api/reviews`; // Nova rota para reviews

    function deveIgnorarAtributoPorNome(nome) {
        if (!nome) return false;
        const nomeLower = nome.toLowerCase();
        const FRASES_IGNORADAS_NOME_ATRIBUTO = ['nÃºmero de', 'nÃºmero do', 'registro de', 'registro do'];
        return FRASES_IGNORADAS_NOME_ATRIBUTO.some(frase => nomeLower.startsWith(frase));
    }

    function normalizeMlbId(input) {
        const regex = /(MLB|MLBU)-?(\d+)/i;
        const match = input.match(regex);
        return match ? match[1].toUpperCase() + match[2] : null;
    }

    function getPalavrasUnicas(texto) {
        if (!texto) return new Set();
        return new Set(texto.toLowerCase().replace(/[.,!?;:()"'/\\-]/g, ' ').split(/\s+/).filter(p => p && p.length >= 3));
    }

    function encontrarIntersecao(set1, set2) {
        const repetidas = [];
        for (const palavra of set1) { if (set2.has(palavra)) repetidas.push(palavra); }
        return repetidas;
    }

    function definirCorPorQuantidadeCaracteres(caracteresValor, attributeId = null, valorTexto = '') {
        if (VALORES_IGNORADOS_PENALIDADE.has(valorTexto.toLowerCase())) return 'inherit';
        if (attributeId === 'BRAND' && caracteresValor > 0 && caracteresValor < TAMANHO_IDEAL_ATRIBUTO) return 'green';
        if (caracteresValor >= 20 && caracteresValor <= TAMANHO_IDEAL_ATRIBUTO) return 'green';
        if (caracteresValor > TAMANHO_IDEAL_ATRIBUTO && caracteresValor <= TAMANHO_IDEAL_ATRIBUTO + 10) return 'gray';
        if (caracteresValor === 0) return 'red';
        return 'red';
    }

    function exibirTitulo(titulo, isMlbu = false, containerId = "tituloTexto") {
        const el = document.getElementById(containerId);
        if (!el) return;
        const len = titulo ? titulo.length : 0;

        // Configura ranges baseados em MLBU ou MLB
        const idealMin = isMlbu ? 50 : MIN_CHARS_TITULO_BOM;
        const idealMax = isMlbu ? 999 : MAX_CHARS_TITULO_BOM; // MLBU sem limite max

        let state = 'bad';
        let progressPercent = 0;

        if (len >= idealMin && (isMlbu || len <= idealMax)) {
            state = 'good';
            progressPercent = 100;
        } else if (len >= 40) { // Regra genÃ©rica de aceitÃ¡vel
            state = 'neutral';
            progressPercent = 70;
        } else {
            progressPercent = Math.max(10, (len / 60) * 100);
        }

        const badgeClass = state;
        const badgeText = state === 'good' ? 'Excelente' : (state === 'neutral' ? 'AceitÃ¡vel' : 'Muito Curto');

        el.innerHTML = `
        <div class="ana-card" style="animation-delay: 0.1s;">
            <div class="ana-card-header">
                <span class="ana-card-icon">ðŸ“</span>
                <span class="ana-card-title">AnÃ¡lise do TÃ­tulo</span>
                <span class="status-badge ${badgeClass}" style="margin-left:auto;">${badgeText}</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p class="title-display">${titulo || 'Nenhum tÃ­tulo encontrado'}</p>
                <div class="char-counter-bar">
                    <div class="char-progress ${state}" style="width: ${progressPercent}%"></div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                     <span class="text-small">${len} caracteres</span>
                     <span class="text-small">Meta: ${idealMin}+</span>
                </div>
            </div>

            ${state !== 'good' ? `
            <div class="info-box" style="margin-bottom:0; background:#fff7ed; border-color:#fed7aa; color:#9a3412;">
                 <p><strong>Dica:</strong> TÃ­tulos detalhados entre ${idealMin} e ${idealMax || 60} caracteres ajudam na busca do Mercado Livre.</p>
            </div>
            ` : ''}
        </div>
    `;

        // Animate progress bar width after render
        setTimeout(() => {
            const bar = el.querySelector('.char-progress');
            if (bar) bar.style.width = `${Math.min(100, (len / 60) * 100)}%`;
        }, 300);
    }

    function exibirDescricaoIndicator(descriptionData, containerId = "descricaoIndicator") {
        const el = document.getElementById(containerId);
        if (!el) return;
        const hasDesc = descriptionData?.plain_text?.trim() !== "";
        const badgeClass = hasDesc ? 'success' : 'muted';
        const text = hasDesc ? 'DescriÃ§Ã£o Detectada' : 'Sem DescriÃ§Ã£o em Texto';

        el.innerHTML = `
        <div class="ana-card" style="padding: 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight:600; font-size:1rem;">DescriÃ§Ã£o em Texto</span>
                <span class="status-badge ${badgeClass}">${text}</span>
            </div>
        </div>
    `;
    }

    function processarAtributos(fichaTecnica, titulo, usedFallback = false, containerId = "fichaTecnicaTexto") {
        const el = document.getElementById(containerId);
        if (!el) return;

        if (!Array.isArray(fichaTecnica) || fichaTecnica.length === 0) {
            el.innerHTML = `
        <div class="ana-card" style="animation-delay: 0.2s;">
            <div class="ana-card-header"><span class="ana-card-icon">ðŸ“‹</span><span class="ana-card-title">Ficha TÃ©cnica</span></div>
            <p class="text-small">Nenhuma ficha tÃ©cnica disponÃ­vel.</p>
        </div>`;
            return;
        }

        const pTit = getPalavrasUnicas(titulo);
        const validAttrs = fichaTecnica.filter(a => typeof a === 'object' && a && a.value_type === 'string' && typeof a.value_name === 'string' && !ATRIBUTOS_IGNORADOS_COMPLETAMENTE.has(a.id));

        const problemAttrs = [];
        const okAttrs = [];

        const pPorAttr = new Map();
        validAttrs.forEach(a => pPorAttr.set(a.id, getPalavrasUnicas(a.value_name)));

        validAttrs.forEach(attr => {
            const nome = attr.name || attr.id;
            const valor = attr.value_name.trim();
            const vLow = valor.toLowerCase();
            const len = valor.length;
            const ignorarPenalidades = deveIgnorarAtributoPorNome(nome);

            let issues = [];

            if (!ignorarPenalidades) {
                // Check Length
                if (!VALORES_IGNORADOS_PENALIDADE.has(vLow)) {
                    if (len > TAMANHO_IDEAL_ATRIBUTO) {
                        issues.push('NÃ£o Indexa (>30)');
                    } else if (len < 20 && attr.id !== 'BRAND') {
                        issues.push('Muito Curto (<20)');
                    }
                }

                // Check Repetition
                if (!ATRIBUTOS_IGNORADOS_REPETICAO.has(attr.id) && !VALORES_IGNORADOS_PENALIDADE.has(vLow)) {
                    const pAtuais = pPorAttr.get(attr.id);
                    if (encontrarIntersecao(pAtuais, pTit).length > 0) issues.push('Repete TÃ­tulo');

                    // Repetition Internal
                    let reptOutros = false;
                    pPorAttr.forEach((pOutro, outroId) => {
                        if (attr.id !== outroId && !ATRIBUTOS_IGNORADOS_REPETICAO.has(outroId)) {
                            const otherAttr = validAttrs.find(a => a.id === outroId);
                            if (otherAttr && !VALORES_IGNORADOS_PENALIDADE.has(otherAttr.value_name.toLowerCase())) {
                                if (encontrarIntersecao(pAtuais, pOutro).length > 0) reptOutros = true;
                            }
                        }
                    });
                    if (reptOutros) issues.push('Valor Duplicado');
                }
            }

            if (issues.length > 0) {
                problemAttrs.push({ name: nome, value: valor, issues });
            } else {
                okAttrs.push({ name: nome, value: valor });
            }
        });

        const renderList = (list, isProblem) => {
            if (list.length === 0) return '';
            return list.map(item => `
            <div class="attribute-item ${isProblem ? 'problem' : ''}">
                <div>
                    <span class="text-label" style="margin-bottom:2px;">${item.name}</span>
                    <span class="text-value">${item.value}</span>
                </div>
                ${isProblem ? `<div class="status-badge error" style="font-size:0.75rem;">${item.issues.join(', ')}</div>` : '<span style="color:#10b981; font-weight:bold;">âœ” OK</span>'}
            </div>
        `).join('');
        };

        el.innerHTML = `
        <div class="ana-card" style="animation-delay: 0.2s;">
            <div class="ana-card-header">
                <span class="ana-card-icon">ðŸ“‹</span>
                <span class="ana-card-title">Ficha TÃ©cnica</span>
            </div>
            
            ${problemAttrs.length > 0 ? `
                <div class="specs-group">
                    <div class="specs-group-title problem">âš ï¸ AtenÃ§Ã£o NecessÃ¡ria (${problemAttrs.length})</div>
                    ${renderList(problemAttrs, true)}
                </div>
            ` : ''}

            ${okAttrs.length > 0 ? `
                <div class="specs-group">
                     <div class="specs-group-title valid">âœ… Tudo Certo (${okAttrs.length})</div>
                    ${renderList(okAttrs, false)}
                </div>
            ` : ''}
            
             ${usedFallback ? '<p class="text-small" style="margin-top:10px;">â„¹ï¸ Dados via Scraper (Parcial)</p>' : ''}
        </div>
    `;
    }

    function exibirAtributosCategoria(categoryAttributes, adAttributes, containerId = "categoryAttributes") {
        const el = document.getElementById(containerId);
        if (!el) return;

        let contentHtml = '';
        const stringAttributes = Array.isArray(categoryAttributes) ? categoryAttributes.filter(attr => attr.value_type === 'string' && !attr.tags?.read_only) : [];

        if (!Array.isArray(categoryAttributes) || stringAttributes.length === 0) {
            // Hide completely if no relevant attributes to show, or show message
            contentHtml = '<p class="text-small">Sem campos adicionais sugeridos para esta categoria.</p>';
        } else {
            const adAttributesMap = new Map(adAttributes.map(attr => [attr.id, attr.value_name]));

            // Sort: Faltando first
            stringAttributes.sort((a, b) => {
                const valA = adAttributesMap.get(a.id);
                const valB = adAttributesMap.get(b.id);
                const filledA = valA && valA.trim() !== '';
                const filledB = valB && valB.trim() !== '';
                return filledA === filledB ? 0 : (filledA ? 1 : -1);
            });

            contentHtml = '<div style="display:flex; flex-direction:column; gap:8px;">';

            stringAttributes.forEach(catAttr => {
                const adValue = adAttributesMap.get(catAttr.id);
                const isFilled = adValue && adValue.trim() !== '';

                contentHtml += `
                 <div class="attribute-item" style="${!isFilled ? 'background:#fff1f2; border-color:#fda4af;' : ''}">
                    <div>
                        <span class="text-label" style="margin-bottom:2px;">${catAttr.name}</span>
                        ${isFilled ? `<span class="text-value">${adValue}</span>` : '<span class="text-small" style="color:#ef4444;">NÃ£o preenchido</span>'}
                    </div>
                    ${isFilled ? '<span style="color:#10b981;">âœ”</span>' : '<span class="status-badge error">Faltando</span>'}
                </div>
            `;
            });
            contentHtml += '</div>';
        }

        el.innerHTML = `
        <div class="ana-card" style="animation-delay: 0.25s;">
            <div class="ana-card-header">
                <span class="ana-card-icon">ðŸ“‚</span>
                <span class="ana-card-title">Campos da Categoria</span>
            </div>
            ${contentHtml}
        </div>
    `;
    }

    function exibirInformacaoGarantia(detail, containerId = "warrantyInfo") {
        const el = document.getElementById(containerId);
        if (!el) return;
        const temGarantia = detail?.warranty;
        const badgeClass = temGarantia ? 'success' : 'error';
        const text = temGarantia ? 'Garantia Informada' : 'Sem Garantia';

        el.innerHTML = `
        <div class="ana-card" style="padding: 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-weight:600; font-size:1rem;">Garantia</span>
                <span class="status-badge ${badgeClass}">${text}</span>
            </div>
        </div>
    `;
    }

    function verificarTags(tags, usedFallback = false, containerId = "tagsTexto") {
        const el = document.getElementById(containerId);
        if (!el) return;

        let contentHtml = '';
        if (usedFallback) {
            contentHtml = '<p class="text-small">AnÃ¡lise de tags indisponÃ­vel (Scraper).</p>';
        } else if (!Array.isArray(tags) || tags.length === 0) {
            contentHtml = '<p class="text-small">Nenhuma tag ativa encontrada.</p>';
        } else {
            contentHtml = '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
            tags.forEach(tag => {
                const isAlertTag = TAGS_NEGATIVAS.has(tag);
                const isGoodTag = typeof tag === 'string' && (tag.includes('good_quality') || tag === 'brand_verified');

                let badgeClass = 'muted';
                if (isAlertTag) badgeClass = 'error';
                else if (isGoodTag) badgeClass = 'success';

                const significado = tagSignificados[tag] || null;
                const titleAttr = significado ? `title="${significado}"` : '';

                contentHtml += `<span class="status-badge ${badgeClass}" ${titleAttr} style="cursor:help;">${tag}</span>`;
            });
            contentHtml += '</div>';
        }

        div.innerHTML = `
         <div class="ana-card">
            <div class="ana-card-header">
                <span class="ana-card-icon">ðŸ·ï¸</span>
                <span class="ana-card-title">Tags Ativas</span>
            </div>
            ${contentHtml}
        </div>
    `;
    }

    function exibirUpTags(tags, containerId = "upTagsTexto") {
        const el = document.getElementById(containerId);
        if (!el) return;
        let html = `<h4 class="section-title-underlined">Tags do Produto (UP)</h4>`;
        if (!Array.isArray(tags) || tags.length === 0) {
            html += `<p class="status-message" style="color: gray;">Nenhuma tag encontrada para este produto.</p>`;
            el.innerHTML = html; return;
        }
        let ulHtml = '<ul>';
        tags.forEach(tag => {
            ulHtml += `<li style="margin-bottom: 4px;"> â„¹ï¸ <strong>${tag}</strong></li>`;
        });
        ulHtml += '</ul>';
        el.innerHTML = html + ulHtml;
    }


    function exibirPerformance(performanceData, containerId = "performanceTexto") {
        const perfEl = document.getElementById(containerId);
        if (!perfEl) return;

        if (!performanceData || typeof performanceData !== 'object' || Object.keys(performanceData).length === 0) {
            perfEl.innerHTML = `
            <div class="ana-card" style="animation-delay: 0.3s;">
                <div class="ana-card-header"><span class="ana-card-icon">âš¡</span><span class="ana-card-title">Qualidade Detalhada</span></div>
                <p class="text-small">Sem detalhes avanÃ§ados disponÃ­veis.</p>
            </div>`;
            return;
        }

        let bucketsHtml = '';
        if (Array.isArray(performanceData.buckets)) {
            performanceData.buckets.forEach(bucket => {
                if (!bucket || typeof bucket !== 'object') return;

                const bScore = bucket.score !== undefined ? Math.round(bucket.score) : 0;
                const bLevel = bScore >= 75 ? 'good' : (bScore < 50 ? 'bad' : 'neutral');
                const color = bLevel === 'good' ? '#10b981' : (bLevel === 'bad' ? '#ef4444' : '#f59e0b');

                let varsHtml = '';

                // Collect variables
                const vars = Array.isArray(bucket.variables) ? bucket.variables : [];
                vars.forEach(v => {
                    const vScore = v.score !== undefined ? Math.round(v.score) : 0;
                    const vStatus = v.status || 'UNKNOWN';
                    const isError = vStatus === 'ERROR' || vScore < 50;
                    const vColor = vStatus === 'COMPLETED' || vScore >= 75 ? '#10b981' : (isError ? '#ef4444' : '#f59e0b');

                    let rulesHtml = '';
                    if (vStatus !== 'COMPLETED' && Array.isArray(v.rules)) {
                        v.rules.forEach(r => {
                            if (r.wordings?.title) {
                                rulesHtml += `<div class="text-small" style="margin-top:5px; padding-left:10px; border-left:2px solid ${vColor}; color:#64748b;">ðŸ’¡ ${r.wordings.title}</div>`;
                            }
                        });
                    }

                    const statusMap = { 'COMPLETED': 'ConcluÃ­do', 'PENDING': 'Pendente', 'ERROR': 'Erro' };
                    const translatedStatus = statusMap[vStatus] || vStatus;

                    varsHtml += `
                    <div style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:0.9rem; color:${vColor}; font-weight:600;">${v.title || v.key}</span>
                            <span class="text-small" style="background:${vColor}20; color:${vColor}; padding:2px 8px; border-radius:10px;">${translatedStatus}</span>
                        </div>
                        ${rulesHtml}
                    </div>
                `;
                });

                bucketsHtml += `
                <div style="margin-bottom:20px; border:1px solid #e2e8f0; border-radius:8px; padding:15px; border-left:4px solid ${color}; background:#fff;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px dashed #e2e8f0; padding-bottom:10px;">
                        <span style="font-weight:700; color:${color};">${bucket.title || bucket.key}</span>
                        <span style="font-weight:700; font-size:1.1rem; color:${color};">${bScore}%</span>
                    </div>
                    ${varsHtml}
                </div>
            `;
            });
        }

        perfEl.innerHTML = `
        <div class="ana-card" style="animation-delay: 0.3s;">
            <div class="ana-card-header">
                <span class="ana-card-icon">âš¡</span>
                <span class="ana-card-title">DiagnÃ³stico</span>
            </div>
            <div>
                 <p class="text-small" style="margin-bottom:15px;">
                    <strong>NÃ­vel:</strong> ${performanceData.level_wording || 'N/A'} 
                    ${performanceData.mode ? `<span class="status-badge muted">${performanceData.mode}</span>` : ''}
                 </p>
                 ${bucketsHtml}
            </div>
        </div>
    `;
    }

    function exibirPontuacao(score, usedFallback = false, containerId = "qualityScore") {
        const el = document.getElementById(containerId);
        if (!el) return;

        let level = 'bad';
        if (score >= 75) level = 'good'; else if (score >= 50) level = 'neutral';

        // SVG Gradient Definition (one-time injection if needed, but here inline is safer)
        const defs = `
        <defs>
            <linearGradient id="gradientGood" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#34d399;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
            </linearGradient>
        </defs>
    `;

        // Calculate Dash Array for SVG stroke
        // RADIUS = 18. Circle length = 2 * PI * 18 approx 113.
        const radius = 15.9155;
        const circumference = 100; // Normalized to 100 for easy calc
        const strokeDasharray = `${score}, 100`;

        const celebration = score === 100 ? '<div class="celebration-confetti">ðŸŽ‰</div>' : '';

        el.innerHTML = `
        <div class="ana-card" style="align-items: center; text-align: center; justify-content: center; animation-delay: 0s;">
            <div class="ana-card-header" style="width:100%; justify-content:center; border-bottom:none;">
                <span class="ana-card-title">Qualidade do AnÃºncio</span>
            </div>
            
            <div class="score-container">
                ${celebration}
                 <div class="score-circle-outer">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                        ${defs}
                        <path class="circle-bg"
                            d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                        />
                        <path class="circle ${level}"
                            stroke-dasharray="0, 100"
                            d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                        />
                    </svg>
                    <span class="score-number">${score}</span>
                 </div>
            </div>

            <div style="margin-top: 10px;">
                <span class="status-badge ${level === 'good' ? 'success' : (level === 'neutral' ? 'muted' : 'error')}">
                    ${level === 'good' ? 'Excelente' : (level === 'neutral' ? 'Regular' : 'Precisa Melhorar')}
                </span>
            </div>
            ${usedFallback ? '<p class="text-small" style="margin-top:10px;">âš  Estimativa (Dados limitados)</p>' : ''}
        </div>
    `;

        // Animate stroke
        setTimeout(() => {
            const circle = el.querySelector('.circle');
            if (circle) circle.setAttribute('stroke-dasharray', strokeDasharray);
        }, 200);
    }

    function appendError(message, containerId = 'resultsContainer') {
        const cont = document.getElementById(containerId);
        if (!cont) return;
        if (containerId === 'resultsContainer') cont.classList.remove('initial-state');
        if (Array.from(cont.querySelectorAll('.error-message')).some(el => el.textContent.includes(message))) return;
        const p = document.createElement('p');
        p.className = 'error-message';
        p.innerHTML = `âŒ ${message}`;
        cont.appendChild(p);
    }

    function clearResults() {
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
            resultsContainer.innerHTML = '';
        }
    }


    function hideLoading() {
        const el = document.getElementById("loadingIndicator");
        if (el) el.style.display = 'none';
    }

    // --- Credential Fetching (FunÃ§Ãµes Atualizadas) ---
    async function fetchAccessToken() {
        try {
            const r = await fetch('https://app.marketfacil.com.br/api/1.1/wf/getAccessToken2');
            if (!r.ok) {
                const d = await r.text(); // Tenta pegar texto se nÃ£o for JSON
                throw new Error(`HTTP ${r.status}: ${d}`);
            }
            const d = await r.json();
            if (d?.response?.access_token) {
                console.log("Access Token OK.");
                return d.response.access_token;
            }
            console.warn('Token nÃ£o encontrado na resposta:', d);
            throw new Error('Token nÃ£o encontrado na resposta.');
        } catch (e) {
            console.error('Erro ao buscar Access Token:', e.message);
            return null;
        }
    }

    async function fetchUserIdForScraping() { // Nome da funÃ§Ã£o atualizado
        try {
            const r = await fetch('https://app.marketfacil.com.br/api/1.1/wf/get-user-id', {
                method: 'POST' // Assegura que o mÃ©todo Ã© POST se necessÃ¡rio
            });
            if (!r.ok) {
                const d = await r.text();
                throw new Error(`HTTP ${r.status}: ${d}`);
            }
            const d = await r.json();
            // LÃ³gica mais robusta para extrair user_id
            let uId = d?.response?.user_id || d?.user_id || (typeof d === 'string' && d.match(/^\d+x\d+$/) ? d : null);
            if (uId) {
                console.log("User ID OK.");
                return uId;
            }
            console.warn('User ID nÃ£o encontrado na resposta:', d);
            throw new Error('User ID nÃ£o encontrado na resposta.');
        } catch (e) {
            console.error('Erro ao buscar User ID:', e.message);
            return null;
        }
    }

    async function fetchApiData(fullUrl, accessToken) {
        console.log(`Buscando dados de ${fullUrl}...`);
        try {
            const response = await fetch(fullUrl, { headers: accessToken ? { 'Authorization': `Bearer ${accessToken}` } : {} });
            console.log(`Status: ${response.status}`);
            if (!response.ok) {
                let errorMsg = `Erro ${response.status}`;
                try { const errorData = await response.json(); errorMsg += `: ${errorData.message || errorData.error || JSON.stringify(errorData)}`; } catch (e) { /*ignore*/ }
                throw new Error(errorMsg);
            }
            const data = await response.json();
            console.log(`Resposta (parcial):`, JSON.stringify(data).substring(0, 200) + "...");
            return data;
        } catch (error) {
            console.error(`Erro ao buscar ${fullUrl}:`, error);
            return null;
        }
    }

    async function fetchItemDetails(itemIds, accessToken) {
        const url = `${API_FETCH_ITEM_ENDPOINT}?item_id=${itemIds.join(',')}`;
        return fetchApiData(url, accessToken);
    }

    async function fetchPerformanceData(itemId, accessToken) { return fetchApiData(`${API_PERFORMANCE_ENDPOINT}?item_id=${itemId}`, accessToken); }
    async function fetchCategoryAttributes(categoryId, accessToken) { return fetchApiData(`${API_ATTRIBUTES_ENDPOINT}/${categoryId}`, accessToken); }

    function transformMlbuData(mlbuData) {
        if (!mlbuData || typeof mlbuData !== 'object') return null;
        const transformedAttributes = mlbuData.attributes.map(attr => {
            const value = attr.values && attr.values.length > 0 ? attr.values[0] : {};
            return {
                id: attr.id,
                name: attr.name,
                value_name: value.name || null,
                value_type: attr.value_type || 'string'
            };
        });

        return {
            id: mlbuData.id,
            title: mlbuData.name,
            category_id: mlbuData.domain_id.replace('MLB-', ''),
            seller_id: mlbuData.user_id,
            attributes: transformedAttributes,
            tags: mlbuData.tags || [],
            warranty: null,
            pictures: mlbuData.pictures || []
        };
    }

    async function fetchVisits(itemId, accessToken) {
        // Tenta usar o Core se disponÃ­vel (mesmo usado pelo visits.js)
        if (window.MarketFacilCore && typeof window.MarketFacilCore.getVisits === 'function') {
            try {
                console.log('Utilizando MarketFacilCore.getVisits...');
                return await window.MarketFacilCore.getVisits(itemId, '30'); // '30' dias como string para garantir compatibilidade
            } catch (e) {
                console.warn('Falha no Core, tentando rota direta...', e);
            }
        }
        // Busca visitas dos Ãºltimos 30 dias para cÃ¡lculo de tendÃªncia via rota direta
        return fetchApiData(`${API_VISITS_ENDPOINT}?item_id=${itemId}&days=30`, accessToken);
    }

    async function fetchReviews(itemId, accessToken) {
        return fetchApiData(`${API_REVIEWS_ENDPOINT}/${itemId}`, accessToken);
    }

    function exibirTendenciaVisitas(visitsData, containerId = "visitsTrend") {
        const el = document.getElementById(containerId);
        if (!el) return;

        if (!visitsData || visitsData.error) {
            let motivo = "IndisponÃ­vel no momento.";
            if (visitsData && visitsData.error === 'not_owner') motivo = "Restrito ao vendedor.";
            else if (visitsData && visitsData.error) motivo = "Erro na busca.";

            el.innerHTML = `
            <div class="ana-card" style="animation-delay: 0.1s;">
                <div class="ana-card-header">
                    <span class="ana-card-icon">ðŸ“Š</span>
                    <span class="ana-card-title">Visitas (30 dias)</span>
                </div>
                <p class="text-small" style="color: var(--ana-text-muted); font-style:italic;">${motivo}</p>
            </div>`;
            return;
        }

        // Even if results are empty, if we didn't get an error, we might want to show "0 visits" instead of hiding/erroring if we want to be explicit.
        // But usually results=[] means no data found. Let's assume valid results array.
        const results = visitsData.results || [];
        // Ensure chronological order for trend calculation
        results.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Calculate totals first to decide if we show "No visits" or just 0
        // If we have an empty array, that's effectively 0 visits.

        const midPoint = Math.floor(results.length / 2);
        const firstHalf = results.slice(0, midPoint);
        const secondHalf = results.slice(midPoint);
        const sumVisits = (arr) => arr.reduce((acc, curr) => acc + (curr.total || 0), 0);
        const totalFirst = sumVisits(firstHalf);
        const totalSecond = sumVisits(secondHalf);
        const totalVisits = totalFirst + totalSecond;

        // Show card even for 0 visits if we successfully queried


        let trend = 'EstÃ¡vel';
        let icon = 'âž¡ï¸';
        let colorClass = 'muted';
        let percentChange = 0;

        if (totalFirst === 0) {
            percentChange = totalSecond > 0 ? 100 : 0;
        } else {
            percentChange = ((totalSecond - totalFirst) / totalFirst) * 100;
        }

        if (percentChange > 5) { trend = 'Subindo'; icon = 'ðŸ“ˆ'; colorClass = 'success'; }
        else if (percentChange < -5) { trend = 'Caindo'; icon = 'ðŸ“‰'; colorClass = 'error'; }

        const lowDataWarning = totalVisits < 10 ? '<div class="margin-top:8px;"><span class="status-badge muted">âš ï¸ Poucos dados</span></div>' : '';

        el.innerHTML = `
        <div class="ana-card" style="animation-delay: 0.1s;">
            <div class="ana-card-header">
                <span class="ana-card-icon">ðŸ“Š</span>
                <span class="ana-card-title">TendÃªncia Visitas</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="trend-indicator">
                    <span class="trend-icon">${icon}</span>
                    <span class="trend-text ${colorClass}">${trend}</span>
                    <span class="text-small" style="margin-top:2px;">${percentChange === 100 && totalFirst === 0 ? 'Novo' : percentChange.toFixed(1) + '%'}</span>
                </div>
                <div class="trend-stats" style="flex-grow:1;">
                    <div class="trend-row"><span class="text-small">Total (30d)</span> <span class="text-value">${totalVisits}</span></div>
                    <div class="trend-row"><span class="text-small">1Âª Quinzena</span> <span class="text-value">${totalFirst}</span></div>
                    <div class="trend-row"><span class="text-small">2Âª Quinzena</span> <span class="text-value">${totalSecond}</span></div>
                </div>
            </div>
            ${lowDataWarning}
        </div>
    `;
    }

    function exibirAvaliacoes(reviewsData, containerId = "reviewsContainer") {
        const el = document.getElementById(containerId);
        if (!el) return;

        if (!reviewsData || !reviewsData.paging || reviewsData.paging.total === 0) {
            el.innerHTML = `
            <div class="ana-card">
                <div class="ana-card-header"><span class="ana-card-icon">â­</span><span class="ana-card-title">AvaliaÃ§Ãµes</span></div>
                <p class="text-small">Nenhuma avaliaÃ§Ã£o encontrada.</p>
            </div>`;
            return;
        }

        const average = reviewsData.rating_average || 0;
        const total = reviewsData.paging.total || 0;
        const reviews = reviewsData.reviews || [];

        const starsHtml = (score) => {
            let s = '';
            for (let i = 1; i <= 5; i++) s += i <= Math.round(score) ? 'â˜…' : 'â˜†';
            return `<span class="review-stars">${s}</span>`;
        };

        let html = `
        <div class="ana-card" style="animation-delay: 0.1s;">
            <div class="ana-card-header"><span class="ana-card-icon">â­</span><span class="ana-card-title">AvaliaÃ§Ãµes</span></div>
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                <span class="review-score-big">${average.toFixed(1)}</span>
                <div style="display: flex; flex-direction: column;">
                    ${starsHtml(average)}
                    <span class="text-small">${total} opiniÃµes</span>
                </div>
            </div>
            <div class="reviews-list" style="max-height: 250px; overflow-y: auto;">
    `;

        if (reviews.length === 0) {
            html += '<p class="text-small">Sem comentÃ¡rios recentes.</p>';
        } else {
            reviews.slice(0, 5).forEach(rev => {
                html += `
                <div class="review-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        ${starsHtml(rev.rate)}
                        <span class="text-small">${new Date(rev.date_created).toLocaleDateString()}</span>
                    </div>
                    <p class="text-small" style="color: var(--ana-text-main); font-style: italic;">"${rev.content || 'Sem comentÃ¡rio'}"</p>
                </div>
            `;
            });
        }

        html += '</div></div>';
        el.innerHTML = html;
    }

    async function analisarAnuncio(itemIdToAnalyze = null, append = false) {
        const loader = document.getElementById('loadingIndicator');

        try {
            if (loader) {
                loader.querySelector('span').textContent = 'Analisando, por favor aguarde... â³';
                loader.style.display = 'flex';
            }

            if (!append) {
                clearResults();
            }

            let itemId = itemIdToAnalyze;

            if (!itemId) {
                const inputEl = document.getElementById('input-url');
                if (inputEl) {
                    const val = inputEl.value.trim();
                    if (val) itemId = normalizeMlbId(val);
                }
            }

            if (!itemId) {
                appendError('ID ou link invÃ¡lido. Formato: MLB/MLBU123456789 ou link.');
                return;
            }

            console.log(`--- Iniciando AnÃ¡lise: ${itemId} ---`);
            let accessToken, userId, detail = null, fetchError = null, usedFallback = false, performanceData = null, visitsData = null, reviewsData = null, descriptionData = null, categoryAttributes = null;

            try {
                [accessToken, userId] = await Promise.all([fetchAccessToken(), fetchUserIdForScraping()]);
                if (!accessToken) console.warn('Access Token indisponÃ­vel.');
                if (!userId) console.warn('User ID indisponÃ­vel.');
            } catch (e) {
                console.error("Erro ao buscar credenciais:", e);
                fetchError = new Error('Falha crÃ­tica ao obter credenciais da aplicaÃ§Ã£o.');
            }

            let isMlbu = itemId.startsWith('MLBU');

            if (accessToken && !fetchError) {
                try {
                    if (isMlbu) {
                        const mlbuData = await fetchApiData(`${API_USER_PRODUCTS_ENDPOINT}/${itemId}`, accessToken);
                        if (mlbuData?.id) {
                            detail = transformMlbuData(mlbuData);
                            console.log('Dados do Produto (MLBU) OK.');

                            const itemsData = await fetchApiData(`${API_USER_PRODUCTS_ENDPOINT}/${itemId}/items?seller_id=${detail.seller_id}`, accessToken);
                            if (itemsData?.results?.length > 0) {
                                if (loader) loader.querySelector('span').textContent = 'Buscando detalhes dos anÃºncios... â³';
                                await displayMlbuResults(detail, itemsData.results, accessToken);
                                return; // Retorna para o finally esconder o loader
                            } else {
                                throw new Error(`Nenhum anÃºncio (MLB) associado a este produto (MLBU) foi encontrado.`);
                            }
                        } else {
                            throw new Error(`API de Produtos do UsuÃ¡rio: Resposta sem dados vÃ¡lidos.`);
                        }
                    } else { // Rota MLB
                        const data = await fetchItemDetails([itemId], accessToken);
                        const itemData = data?.[0];
                        if (itemData?.body?.id) {
                            detail = itemData.body;
                            descriptionData = detail.description;
                            console.log('Dados da API de Itens OK.');
                        } else {
                            throw new Error(`API de Itens: Resposta sem dados vÃ¡lidos ou com erro. Corpo: ${JSON.stringify(itemData)}`);
                        }
                    }
                } catch (e) { console.warn(`Erro na API principal: ${e.message}`); fetchError = e; }
            } else if (!fetchError) {
                fetchError = new Error("Para analisar, vocÃª precisa conectar sua conta do Mercado Livre na seÃ§Ã£o 'Minha Conta'.");
                console.log(fetchError.message);
            }

            if (accessToken && detail) {
                console.log(`Checking ownership: UserID=${userId}, SellerID=${detail.seller_id}`);
                // Ensure both are treated as strings for comparison and handle potential undefined
                const isOwner = (userId && detail.seller_id && String(detail.seller_id).trim() === String(userId).trim());

                if (isOwner) console.log("UsuÃ¡rio Ã‰ o dono do anÃºncio. Buscando visitas...");
                else console.log("UsuÃ¡rio NÃƒO Ã© o dono do anÃºncio. Visitas restritas.");

                const results = await Promise.allSettled([
                    fetchPerformanceData(detail.id, accessToken),
                    isOwner ? fetchVisits(detail.id, accessToken) : Promise.resolve({ error: 'not_owner' }),
                    fetchReviews(detail.id, accessToken)
                ]);
                performanceData = results[0].status === 'fulfilled' ? results[0].value : null;
                visitsData = results[1].status === 'fulfilled' ? results[1].value : null;
                reviewsData = results[2].status === 'fulfilled' ? results[2].value : null;
            }

            if (detail && detail.category_id && accessToken) {
                categoryAttributes = await fetchCategoryAttributes(detail.category_id, accessToken);
            }

            if (detail && typeof detail === 'object') {
                console.log("Processando dados...");
                const containerIdSuffix = append ? `-${detail.id}` : '';
                const containerHtml = `
                <div class="item-analysis-container" id="analysis-container${containerIdSuffix}">
                    <div class="analysis-grid">
                        <!-- 1. TÃ­tulo (First) -->
                        <div class="grid-full" id="tituloTexto${containerIdSuffix}"></div>

                        <!-- 2. Ficha TÃ©cnica -->
                        <div class="grid-full" id="fichaTecnicaTexto${containerIdSuffix}"></div>

                        <!-- 3. DescriÃ§Ã£o e Garantia -->
                        <div class="grid-half" id="descricaoIndicator${containerIdSuffix}"></div>
                        <div class="grid-half" id="warrantyInfo${containerIdSuffix}"></div>

                        <!-- 4. Visitas e AvaliaÃ§Ãµes -->
                        <div class="grid-half" id="visitsTrend${containerIdSuffix}"></div>
                        <div class="grid-half" id="reviewsContainer${containerIdSuffix}"></div>

                        <!-- 5. Tags -->
                        <div class="grid-full" id="tagsTexto${containerIdSuffix}"></div>

                        <!-- 6. Qualidade do AnÃºncio -->
                        <div class="grid-full" id="qualityScore${containerIdSuffix}"></div>
                         
                         <!-- Performance escondido ou reposicionado se necessÃ¡rio, mas nÃ£o pedido explicitamente na ordem nova exceto "Qualidade". Vou manter performanceTexto junto com Ficha Tecnica ou no final? O usuÃ¡rio pediu "qualidade do anÃºncio" (score) antes de Categoria. "Performance" Ã© o detalhe da qualidade. Vou colocar junto com o Score em visualizaÃ§Ã£o full ou abaixo dele. -->
                        <div class="grid-full" id="performanceTexto${containerIdSuffix}"></div>

                        <!-- 7. Campos da Categoria (Last) -->
                        <div class="grid-full" id="categoryAttributes${containerIdSuffix}"></div>
                    </div>
                </div>
            `;

                if (append) {
                    const resultsContainer = document.getElementById('resultsContainer');
                    resultsContainer.insertAdjacentHTML('beforeend', containerHtml);
                } else {
                    document.getElementById('resultsContainer').innerHTML = containerHtml;
                }

                exibirTitulo(detail.title, `tituloTexto${containerIdSuffix}`);
                exibirDescricaoIndicator(descriptionData, `descricaoIndicator${containerIdSuffix}`);
                processarAtributos(detail.attributes, detail.title, usedFallback, `fichaTecnicaTexto${containerIdSuffix}`);
                exibirAtributosCategoria(categoryAttributes, detail.attributes, `categoryAttributes${containerIdSuffix}`);
                exibirInformacaoGarantia(detail, `warrantyInfo${containerIdSuffix}`);
                verificarTags(detail.tags, usedFallback, `tagsTexto${containerIdSuffix}`);
                exibirPerformance(performanceData, `performanceTexto${containerIdSuffix}`);
                exibirTendenciaVisitas(visitsData, `visitsTrend${containerIdSuffix}`);
                exibirAvaliacoes(reviewsData, `reviewsContainer${containerIdSuffix}`);
                exibirPontuacao(calcularPontuacaoQualidade(detail, descriptionData, usedFallback), usedFallback, `qualityScore${containerIdSuffix}`);
                console.log("--- AnÃ¡lise ConcluÃ­da ---");
            }

            if (!detail) {
                const finalMsg = fetchError ? fetchError.message : "NÃ£o foi possÃ­vel obter ou processar dados do anÃºncio.";
                console.error("Erro Final da AnÃ¡lise:", finalMsg);
                if (!append) {
                    clearResults();
                }
                appendError(`Falha na anÃ¡lise: ${finalMsg}`);
            }

        } catch (e) {
            console.error("Erro geral na funÃ§Ã£o analisarAnuncio:", e);
            appendError(`Ocorreu um erro inesperado: ${e.message}`);
        } finally {
            if (loader) loader.style.display = 'none';
        }
    }

    async function displayMlbuResults(mlbuDetail, mlbItems, accessToken) {
        const resultsContainer = document.getElementById('resultsContainer');

        // Create Grid Container
        resultsContainer.innerHTML = `
        <div class="analysis-grid">
            <div class="grid-full" id="mlbuHeader"></div>
            <div class="grid-full" id="mlbuItemsList"></div>
        </div>
    `;

        // Header Card (Product Info + Tags)
        const headerEl = document.getElementById("mlbuHeader");
        let tagsHtml = '';
        if (mlbuDetail.tags && mlbuDetail.tags.length > 0) {
            tagsHtml = '<div style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">';
            mlbuDetail.tags.forEach(t => tagsHtml += `<span class="status-badge muted">${t}</span>`);
            tagsHtml += '</div>';
        }

        const imgUrl = mlbuDetail.pictures && mlbuDetail.pictures.length > 0 ? mlbuDetail.pictures[0].secure_url : '';

        headerEl.innerHTML = `
        <div class="ana-card" style="flex-direction:row; align-items:center; gap:20px;">
            ${imgUrl ? `<img src="${imgUrl}" alt="${mlbuDetail.title}" style="width:100px; height:100px; object-fit:contain; border-radius:8px; border:1px solid #e2e8f0;">` : ''}
            <div>
                <span class="status-badge success" style="margin-bottom:5px;">Produto de UsuÃ¡rio (MLBU)</span>
                <h3 style="font-size:1.5rem; font-weight:700; color:var(--ana-text-main); line-height:1.2;">${mlbuDetail.title}</h3>
                ${tagsHtml}
            </div>
        </div>
    `;

        // Items List
        const listEl = document.getElementById('mlbuItemsList');
        listEl.innerHTML = `
        <div class="ana-card">
            <div class="ana-card-header">
                <span class="ana-card-icon">ðŸ“¦</span>
                <span class="ana-card-title">AnÃºncios (Itens) Vinculados</span>
            </div>
            <div id="itemsContainer" style="display:flex; flex-direction:column; gap:10px;">
                <p class="text-small" style="margin-bottom:10px;">Selecione um anÃºncio abaixo para ver a anÃ¡lise detalhada:</p>
            </div>
        </div>
    `;
        const itemsInnerContainer = listEl.querySelector('#itemsContainer');

        const itemsDetails = await fetchItemDetails(mlbItems, accessToken);

        if (itemsDetails && itemsDetails.length > 0) {
            itemsDetails.forEach(itemResp => {
                if (itemResp.code === 200 && itemResp.body) {
                    const item = itemResp.body;
                    const listingType = item.listing_type_id === 'gold_special' ? 'ClÃ¡ssico' : (item.listing_type_id === 'gold_pro' ? 'Premium' : item.listing_type_id);
                    const price = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(item.price);

                    const btn = document.createElement('div');
                    btn.className = 'item-list-btn';
                    btn.onclick = () => handleAnalysisClick(item.id, true);
                    btn.innerHTML = `
                    <img src="${item.thumbnail}" class="item-list-img" alt="Thumb">
                    <div style="flex-grow:1;">
                        <span class="text-value" style="font-size:0.95rem;">${item.title}</span>
                        <div style="display:flex; gap:10px; margin-top:4px;">
                            <span class="status-badge muted" style="font-size:0.75rem;">${listingType}</span>
                            <span class="text-label" style="color:var(--ana-success);">${price}</span>
                        </div>
                    </div>
                    <span style="color:var(--ana-primary);">Analisar âž”</span>
                `;
                    itemsInnerContainer.appendChild(btn);
                }
            });
        } else {
            itemsInnerContainer.innerHTML += '<p class="text-small error-message">Nenhum anÃºncio (MLB) encontrado para este produto ou falha ao buscar detalhes.</p>';
        }
    }

    function handleAnalysisClick(itemId = null, append = false) {
        analisarAnuncio(itemId, append);
    }
    // Expose to window for Bubble's HTML element scope
    window.handleAnalysisClick = handleAnalysisClick;

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('input-url');
        if (input) {
            input.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleAnalysisClick();
                }
            });
        }
    });

    function calcularPontuacaoQualidade(detail, descriptionData, usedFallback = false) {
        if (!detail || typeof detail !== 'object') return 0;
        let score = 100;
        const title = detail.title || "", titleLen = title.length, pTit = getPalavrasUnicas(title);

        const isMlbu = detail.id && detail.id.startsWith('MLBU');

        if (isMlbu) {
            // Regra MLBU
            if (titleLen < 40) score += PONTOS_PENALIDADE_TITULO_CURTO; // < 40 muito ruim
            else if (titleLen < 50) score += PONTOS_PENALIDADE_TITULO_MEDIO; // 40-49 mÃ©dio
            // >= 50 OK, sem penalidade por ser longo
        } else {
            // Regra MLB
            if (titleLen < MIN_CHARS_TITULO_RUIM) score += PONTOS_PENALIDADE_TITULO_CURTO;
            else if (titleLen < MIN_CHARS_TITULO_BOM) score += PONTOS_PENALIDADE_TITULO_MEDIO;
        }

        // Penalidade se for muito grande mesmo para MLBU? O usuÃ¡rio disse que >60 ok.
        // Vamos manter sem penalidade extra para MLBU longo por enquanto, conforme pedido.

        if (descriptionData?.plain_text?.trim() !== "") score += PONTOS_BONUS_DESCRICAO;

        if (Array.isArray(detail.attributes) && detail.attributes.length > 0) {
            let validCount = 0;
            const validAttrs = detail.attributes.filter(a => typeof a === 'object' && a && a.value_type === 'string' && typeof a.value_name === 'string' && !ATRIBUTOS_IGNORADOS_COMPLETAMENTE.has(a.id));
            const pPorAttr = new Map(); validAttrs.forEach(a => pPorAttr.set(a.id, getPalavrasUnicas(a.value_name)));
            validAttrs.forEach(attr => {
                validCount++;
                const nome = attr.name || attr.id;
                const val = attr.value_name.trim(), vLow = val.toLowerCase(), len = val.length, pAtuais = pPorAttr.get(attr.id);
                const ignorarPenalidades = deveIgnorarAtributoPorNome(nome);

                if (!ignorarPenalidades) {
                    if (!VALORES_IGNORADOS_PENALIDADE.has(vLow)) {
                        const diff = Math.abs(len - TAMANHO_IDEAL_ATRIBUTO);
                        if (attr.id !== 'BRAND' || len > TAMANHO_IDEAL_ATRIBUTO) {
                            score += Math.floor(diff / 10) * PONTOS_PENALIDADE_POR_10_CHARS_DIF_ATR;
                        }
                    }
                    if (!ATRIBUTOS_IGNORADOS_REPETICAO.has(attr.id) && !VALORES_IGNORADOS_PENALIDADE.has(vLow)) {
                        score += encontrarIntersecao(pAtuais, pTit).length * PONTOS_PENALIDADE_POR_PALAVRA_REPETIDA;
                        let reptOutros = new Set();
                        pPorAttr.forEach((pO, oId) => {
                            const oA = validAttrs.find(a => a.id === oId);
                            if (oA && attr.id !== oId && !ATRIBUTOS_IGNORADOS_REPETICAO.has(oId)) {
                                const oVL = oA.value_name?.trim().toLowerCase();
                                if (oVL && !VALORES_IGNORADOS_PENALIDADE.has(oVL))
                                    encontrarIntersecao(pAtuais, pO).forEach(p => reptOutros.add(p));
                            }
                        });
                        score += reptOutros.size * PONTOS_PENALIDADE_POR_PALAVRA_REPETIDA;
                    }
                }
            });
            if (validCount === 0) score += PONTOS_PENALIDADE_SEM_ATRIBUTOS;
        } else score += PONTOS_PENALIDADE_SEM_ATRIBUTOS * 1.5;

        if (!usedFallback && Array.isArray(detail.tags)) {
            if (detail.tags.includes('moderation_penalty')) score += PONTOS_PENALIDADE_MODERATION_PENALTY;
            if (detail.tags.includes('incomplete_technical_specs')) score -= 15;
            const algumaTagNegativaPresente = detail.tags.some(tagAnuncio => TAGS_NEGATIVAS.has(tagAnuncio));
            if (algumaTagNegativaPresente) {
                if (!detail.tags.includes('moderation_penalty') && !detail.tags.includes('incomplete_technical_specs')) {
                    score -= 10;
                }
            }
        }
        return Math.max(0, Math.min(Math.round(score), 100));
    }

    // End of Analyzer Logic

    /* SCANNER JS */
    /**
     * MarketFÃ¡cil - Account Scanner Widget
     * RepositÃ³rio: Luckys666/frontend-marketfacil
     * 
     * Este script gerencia a busca massiva de anÃºncios e filtragem local via Proxy.
     */

    // Estado Global do Scanner
    window.scannerState = {
        allItems: [],
        uniqueTags: new Set(),
        isScanning: false
    };

    // --- ConfiguraÃ§Ã£o & Constantes ---
    const SCANNER_API_BASE = 'https://mlb-proxy-fdb71524fd60.herokuapp.com';
    const SCANNER_TAGS_NEGATIVAS = new Set([
        "poor_quality_picture", "poor_quality_thumbnail",
        "incomplete_technical_specs", "moderation_penalty"
    ]);

    // --- FunÃ§Ãµes de API (Autocontidas) ---

    async function getScannerAccessToken() {
        if (typeof fetchAccessToken === 'function') return fetchAccessToken();

        try {
            const r = await fetch('https://app.marketfacil.com.br/api/1.1/wf/getAccessToken2');
            if (!r.ok) throw new Error('Falha ao obter token');
            const d = await r.json();
            return d.response.access_token;
        } catch (e) {
            console.error('Erro Token Scanner:', e);
            return null;
        }
    }

    async function getScannerUserId(token) {
        // 1. MÃ©todo Preferencial: Extrair ID diretamente do Token
        // Formato Mercado Livre: APP_USR-Seq-Seq-Seq-UserId (O Ãºltimo segmento Ã© o ID)
        if (token && typeof token === 'string') {
            const parts = token.split('-');
            const possibleId = parts[parts.length - 1]; // Pega o Ãºltimo pedaÃ§o

            // Verifica se parece um ID numÃ©rico vÃ¡lido
            if (possibleId && /^\d+$/.test(possibleId)) {
                console.log('Scanner: ID extraÃ­do do token:', possibleId);
                return parseInt(possibleId, 10);
            }
        }

        // 2. Fallback: Tenta via Proxy (/users/me)
        if (token) {
            try {
                const r = await fetch(`${SCANNER_API_BASE}/api/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (r.ok) {
                    const data = await r.json();
                    return data.id; // Retorna o ID numÃ©rico do MLB
                }
            } catch (e) {
                console.warn('Erro ao buscar ID via Proxy:', e);
            }
        }

        // 3. Fallback: Removido para evitar erros de CORS e IDs invÃ¡lidos (Bubble ID vs MLB ID).
        console.warn('Scanner: NÃ£o foi possÃ­vel obter ID numÃ©rico via Token ou Proxy.');
        return null;
    }

    // --- Core Logic ---

    async function startAccountScan() {
        console.log("Scanner v2.0 - Forced Visibility Update");
        if (window.scannerState.isScanning) return;

        // UI Elements
        const scanBtn = document.getElementById('scanButton');
        const progressDiv = document.getElementById('scanProgress');
        const progressBar = document.getElementById('scanProgressBar');
        const statusText = document.getElementById('scanStatusText');
        const countText = document.getElementById('scanCountText');
        const resultsContainer = document.getElementById('scannerResults');

        // Reset UI
        window.scannerState.isScanning = true;
        window.scannerState.allItems = [];
        window.scannerState.uniqueTags.clear();

        if (scanBtn) scanBtn.disabled = true;
        if (progressDiv) progressDiv.style.display = 'block';
        if (resultsContainer) resultsContainer.innerHTML = '';
        if (progressBar) progressBar.style.width = '0%';

        try {
            if (statusText) statusText.textContent = 'Autenticando...';

            const token = await getScannerAccessToken();
            const userId = await getScannerUserId(token);

            if (!token || !userId) throw new Error('Falha de autenticaÃ§Ã£o. Recarregue a pÃ¡gina.');

            // 1. Fetch All IDs via Proxy
            if (statusText) statusText.textContent = 'Mapeando conta (pode demorar)...';

            const allIds = await scannerFetchAllIds(userId, token, (progress) => {
                if (statusText) statusText.textContent = `Mapeando: ${progress.loaded} anÃºncios encontrados...`;
            });

            const total = allIds.length;
            if (statusText) statusText.textContent = `Processando detalhes de ${total} anÃºncios...`;

            // 2. Fetch Details in Batches (Max 20 per batch for this Proxy Endpoint)
            const BATCH_SIZE = 20;
            let processed = 0;

            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batchIds = allIds.slice(i, i + BATCH_SIZE);
                const items = await scannerFetchDetails(batchIds, token);

                // Process tags & store
                items.forEach(item => {
                    if (item) {
                        window.scannerState.allItems.push(item);
                        if (item.tags) item.tags.forEach(t => window.scannerState.uniqueTags.add(t));
                    }
                });

                processed += batchIds.length;
                const percent = Math.round((processed / total) * 100);

                if (progressBar) progressBar.style.width = `${percent}%`;
                if (statusText) statusText.textContent = `Processando: ${processed}/${total} (${percent}%)`;
            }

            // 3. Finalize
            updateFilterDropdown();
            renderScannerGrid(window.scannerState.allItems);
            updateCount(window.scannerState.allItems.length);

            if (statusText) statusText.textContent = 'Varredura Completa!';
            if (progressBar) progressBar.style.width = '100%';

        } catch (e) {
            console.error('Scanner Error:', e);
            if (statusText) statusText.textContent = `Erro: ${e.message}`;
            alert('Erro ao escanear: ' + e.message);
        } finally {
            window.scannerState.isScanning = false;
            if (scanBtn) scanBtn.disabled = false;
        }
    }

    async function scannerFetchAllIds(userId, token, onProgress) {
        let ids = [];
        let offset = 0;
        let total = 1;
        const LIMIT = 50;
        let scrollId = null;

        // Use Proxy Route for Ads
        const PROXY_ADS_URL = `${SCANNER_API_BASE}/api/fetch-ads`;

        while (offset < total) {
            try {
                let url = `${PROXY_ADS_URL}?seller_id=${userId}&limit=${LIMIT}`;

                // Logic to handle Proxy's scroll/scan support
                if (scrollId) {
                    url += `&scroll_id=${scrollId}`;
                } else {
                    url += `&offset=${offset}`;
                }

                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    const errTxt = await res.text();
                    throw new Error(`Erro Proxy (${res.status}): ${errTxt}`);
                }

                const data = await res.json();

                if (data.results) ids = ids.concat(data.results);
                if (data.paging) total = data.paging.total;
                if (data.scroll_id) scrollId = data.scroll_id; // Capture scroll_id if API returns it

                offset += LIMIT;

                if (onProgress) onProgress({ loaded: ids.length, total });

                await new Promise(r => setTimeout(r, 100)); // Rate limit guard

            } catch (e) {
                console.warn('Erro fetch IDs:', e);
                break;
            }
        }
        return ids;
    }

    async function scannerFetchDetails(ids, token) {
        if (!ids.length) return [];
        try {
            // Use Proxy Endpoint: /fetch-item (Max 20 IDs)
            // returns array of items with 'description' property injected
            const proxyUrl = `${SCANNER_API_BASE}/api/fetch-item?item_id=${ids.join(',')}`;
            const res = await fetch(proxyUrl, { headers: { 'Authorization': `Bearer ${token}` } });

            if (!res.ok) throw new Error(`Status ${res.status}`);

            const data = await res.json();

            // Normaliza a resposta: O endpoint /fetch-item (Multiget) retorna [{ code, body, description }]
            // Precisamos extrair o 'body' para ter os dados planos do item (id, title, price, etc).
            if (Array.isArray(data)) {
                return data.map(item => {
                    // Se tiver a estrutura de multiget (com body), extraÃ­mos.
                    if (item.body) {
                        // Preservamos a description se ela tiver sido injetada pelo Proxy
                        return { ...item.body, description: item.description };
                    }
                    return item;
                });
            }
            return [];

        } catch (e) {
            console.warn('Batch detail err:', e);
            return [];
        }
    }

    // --- UI & Filtering ---

    function updateFilterDropdown() {
        const select = document.getElementById('tagFilter');
        if (!select) return;

        select.innerHTML = '<option value="all">Ver Tudo</option>';

        // Sort tags
        const sortedTags = Array.from(window.scannerState.uniqueTags).sort();

        const critical = ['poor_quality_picture', 'poor_quality_thumbnail', 'incomplete_technical_specs', 'moderation_penalty'];

        const groups = {
            'CrÃ­ticas': [],
            'Informativas': []
        };

        sortedTags.forEach(tag => {
            if (critical.includes(tag)) groups['CrÃ­ticas'].push(tag);
            else groups['Informativas'].push(tag);
        });

        if (groups['CrÃ­ticas'].length) {
            const d = document.createElement('optgroup');
            d.label = "âš ï¸ CrÃ­ticas";
            groups['CrÃ­ticas'].forEach(t => {
                const op = document.createElement('option');
                op.value = t;
                op.textContent = `${t} ðŸš©`;
                d.appendChild(op);
            });
            select.appendChild(d);
        }

        if (groups['Informativas'].length) {
            const d = document.createElement('optgroup');
            d.label = "â„¹ï¸ Outras";
            groups['Informativas'].forEach(t => {
                const op = document.createElement('option');
                op.value = t;
                op.textContent = t;
                d.appendChild(op);
            });
            select.appendChild(d);
        }
    }

    function handleScannerFilterChange() {
        const filter = document.getElementById('tagFilter').value;
        const all = window.scannerState.allItems;

        if (filter === 'all') {
            renderScannerGrid(all);
            updateCount(all.length);
        } else {
            const filtered = all.filter(item => item.tags && item.tags.includes(filter));
            renderScannerGrid(filtered);
            updateCount(filtered.length);
        }
    }

    function updateCount(n) {
        const el = document.getElementById('scanCountText');
        if (el) el.textContent = `${n} exibidos`;
    }

    function renderScannerGrid(items) {
        const container = document.getElementById('scannerResults');
        if (!container) return;
        container.innerHTML = '';

        if (items.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#64748b;">Nenhum item corresponde ao filtro.</div>';
            return;
        }

        const fragment = document.createDocumentFragment();

        items.forEach(item => {
            if (!item) return;

            // NormalizaÃ§Ã£o defensiva: O item pode vir jÃ¡ normalizado ou ainda aninhado em .body
            let safeItem = item;
            if (item.body) {
                safeItem = { ...item.body, description: item.description };
            }

            // Debug para entender o que estÃ¡ chegando
            if (!safeItem.title && safeItem.result) safeItem = safeItem.result; // PossÃ­vel estrutura alternativa?

            console.log('Rendering item:', safeItem.id, safeItem.title, safeItem);


            const div = document.createElement('div');
            div.className = 'ana-card';
            // FIX: 'ana-card' css has opacity:0. We must force opacity:1 or use the correct animation 'slideUpFade' or 'mf-fadeIn'.
            // Adding opacity: 1 explicitly to guarantee visibility.
            div.style.cssText = 'opacity: 1; animation: slideUpFade 0.5s ease forwards; display:flex; flex-direction:column; gap:10px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';

            const thumb = safeItem.thumbnail || 'https://http2.mlstatic.com/D_NQ_NP_906934-MLA47913349685_102021-O.webp'; // Fallback img
            const price = safeItem.price ? `R$ ${safeItem.price.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : '-';

            let tagsHtml = '';
            if (safeItem.tags) {
                safeItem.tags.forEach(t => {
                    const isBad = SCANNER_TAGS_NEGATIVAS.has(t);
                    const color = isBad ? 'error' : 'muted';
                    tagsHtml += `<span class="status-badge ${color}" style="font-size:0.7rem;">${t}</span>`;
                });
            }

            const title = safeItem.title || 'Sem tÃ­tulo';
            const id = safeItem.id || 'N/A';
            const permalink = safeItem.permalink || '#';

            div.innerHTML = `
            <div style="display:flex; gap:12px;">
                <img src="${thumb}" style="width:70px; height:70px; object-fit:cover; border-radius:6px; background:#f8fafc; border:1px solid #eee;">
                <div style="flex:1; min-width:0;">
                    <a href="${permalink}" target="_blank" class="text-value" style="font-size:0.9rem; margin-bottom:4px; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-decoration:none; color:#1e293b; font-weight:600;" title="${title}">${title}</a>
                    <div style="color:#10b981; font-weight:700; font-size:0.95rem;">${price}</div>
                    <div style="color:#64748b; font-size:0.75rem;">${id}</div>
                </div>
            </div>
            <div style="margin-top:10px; padding-top:8px; border-top:1px dashed #e2e8f0;">
                 <div style="display:flex; flex-wrap:wrap; gap:4px;">
                    ${tagsHtml || '<span style="font-size:0.7rem; color:#cbd5e1; font-style:italic; padding:2px 0;">Nenhuma tag relevante.</span>'}
                </div>
            </div>
        `;
            fragment.appendChild(div);
        });

        container.appendChild(fragment);
    }

    // Bind events global
    window.startAccountScan = startAccountScan;
    window.handleScannerFilterChange = handleScannerFilterChange;

    function exportToCSV() {
        const filter = document.getElementById('tagFilter').value;
        const all = window.scannerState.allItems;
        let itemsToExport = [];

        if (filter === 'all') {
            itemsToExport = all;
        } else {
            itemsToExport = all.filter(item => item.tags && item.tags.includes(filter));
        }

        if (itemsToExport.length === 0) {
            alert("Nenhum item para exportar com o filtro atual.");
            return;
        }

        // Mapa de Tradução Simplificado - Foco em Problemas
        const translations = {
            "poor_quality_picture": "Foto de Baixa Qualidade",
            "poor_quality_thumbnail": "Miniatura Ruim",
            "incomplete_technical_specs": "Ficha Técnica Incompleta",
            "moderation_penalty": "Penalidade (Infração)",
            "brand_verified": "Marca Verificada",
            "extended_warranty_eligible": "Elegível Garantia Est.",
            "good_quality_picture": "Foto Boa",
            "good_quality_thumbnail": "Thumb Boa",
            "immediate_payment": "Pgto Imediato",
            "cart_eligible": "Carrinho",
            "free_shipping": "Frete Grátis",
            "catalog_product_candidate": "Candidato a Catálogo"
        };

        // CSV Headers - Ponto e vírgula para Excel PT-BR
        let csvContent = "ID;Título;Preço;Status;Erros Encontrados;Link para Editar\r\n";

        itemsToExport.forEach(item => {
            // Normalização defensiva
            let safeItem = item;
            if (item.body) {
                safeItem = { ...item.body, description: item.description };
            }
            if (!safeItem.title && safeItem.result) safeItem = safeItem.result;

            const id = safeItem.id || '';
            // Tratar aspas e quebras de linha para não quebrar o CSV
            let title = (safeItem.title || '').replace(/"/g, '""').replace(/\n/g, ' ');

            // Formatar preço PT-BR
            const price = safeItem.price ? safeItem.price.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '0,00';

            const permalink = safeItem.permalink || '';
            const tags = safeItem.tags || [];

            // Filtrar Problemas
            const problemas = tags.filter(t => SCANNER_TAGS_NEGATIVAS.has(t));
            const temErro = problemas.length > 0;

            const status = temErro ? "COM ERROS" : "OK";

            // Lista legível de erros
            const listaErros = temErro
                ? problemas.map(p => translations[p] || p).join(', ')
                : "Nenhum";

            // Montar linha com aspas em todos os campos
            csvContent += `"${id}";"${title}";"${price}";"${status}";"${listaErros}";"${permalink}"\r\n`;
        });

        // BOM para UTF-8 no Excel
        const bom = "\uFEFF";
        const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.setAttribute("href", url);
        const date = new Date().toISOString().slice(0, 10);
        link.setAttribute("download", `Relatorio_Scanner_${filter === 'all' ? 'Geral' : filter}_${date}.csv`);

        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    window.exportToCSV = exportToCSV;

</script>